{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}مدیریت دسته‌بندی‌ها{% endblock %}

{% block content %}
<main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-4 sm:p-6" x-data="categoryManager()">
    <div class="container mx-auto">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-slate-700">مدیریت دسته‌بندی‌ها</h1>
            <button @click="openAddModal()" class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-sm transition-colors">
                <i class="fa-solid fa-plus ml-2"></i>
                <span>افزودن دسته‌بندی جدید</span>
            </button>
        </div>

        <!-- جدول دسکتاپ -->
        <div class="hidden lg:block bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="min-w-full text-sm">
                <thead class="bg-slate-50 text-slate-600">
                    <tr>
                        <th scope="col" class="px-6 py-4 text-right font-medium">نام دسته‌بندی</th>
                        <th scope="col" class="px-6 py-4 text-right font-medium">رنگ</th>
                        <th scope="col" class="px-6 py-4 text-center font-medium">عملیات</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    <template x-for="category in categories" :key="category.id">
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap font-semibold" x-text="category.title"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <span class="h-4 w-4 rounded-full" :class="category.color_code"></span>
                                    <span class="mr-3 text-slate-600" x-text="category.color_name"></span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div class="flex justify-center items-center space-x-2 space-x-reverse">
                                    <button @click="openEditModal(category)" class="p-2 text-slate-500 hover:text-yellow-600 rounded-md hover:bg-slate-200" title="ویرایش"><i class="fa-solid fa-pencil"></i></button>
                                    <button @click="openDeleteModal(category)" class="p-2 text-slate-500 hover:text-red-600 rounded-md hover:bg-slate-200" title="حذف"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- کارت‌های موبایل -->
        <div class="grid grid-cols-1 gap-4 lg:hidden">
            <template x-for="category in categories" :key="category.id">
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-slate-800" x-text="category.title"></h3>
                            <div class="flex items-center mt-2">
                                <span class="h-4 w-4 rounded-full" :class="category.color_code"></span>
                                <span class="mr-3 text-slate-600 text-sm" x-text="category.color_name"></span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 space-x-reverse">
                            <button @click="openEditModal(category)" class="p-2 text-slate-500 hover:text-yellow-600 rounded-md hover:bg-slate-100" title="ویرایش"><i class="fa-solid fa-pencil"></i></button>
                            <button @click="openDeleteModal(category)" class="p-2 text-slate-500 hover:text-red-600 rounded-md hover:bg-slate-100" title="حذف"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- مودال افزودن/ویرایش -->
    <div x-show="isModalOpen" x-cloak @keydown.escape.window="closeModal()" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="closeModal()" class="absolute inset-0 bg-slate-900/60"></div>
        <div x-show="isModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-md">
            <div class="p-5 flex justify-between items-center border-b"><h3 class="text-lg font-bold" x-text="modalTitle"></h3><button @click="closeModal()" class="p-1.5 hover:bg-slate-100 rounded-full"><i class="fa-solid fa-times"></i></button></div>
            <form @submit.prevent="saveCategory()">
                {% csrf_token %}
                <div class="p-6 space-y-5">
                    <div>
                        <label for="id_title" class="block text-sm font-medium text-slate-700 mb-2">{{ form.title.label }}</label>
                        {{ form.title }}
                    </div>
                    <div>
                        <label for="id_color_code" class="block text-sm font-medium text-slate-700 mb-2">{{ form.color_code.label }}</label>
                        {{ form.color_code }}
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 rounded-b-xl flex justify-end items-center space-x-3 space-x-reverse">
                    <button type="button" @click="closeModal()" class="py-2 px-5 text-sm font-semibold bg-white border border-slate-300 rounded-lg hover:bg-slate-100">انصراف</button>
                    <button type="submit" class="py-2 px-6 text-sm font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700">ذخیره</button>
                </div>
            </form>
        </div>
    </div>

    <!-- مودال حذف -->
    <div x-show="isDeleteModalOpen" x-cloak @keydown.escape.window="isDeleteModalOpen = false" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="isDeleteModalOpen = false" class="absolute inset-0 bg-slate-900/60"></div>
        <div x-show="isDeleteModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-sm text-center p-6">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i></div>
            <h3 class="text-lg font-medium mb-2">حذف دسته‌بندی</h3>
            <p class="text-sm text-gray-500 mb-4">آیا از حذف <strong x-text="currentCategory.title"></strong> مطمئن هستید؟</p>
            <div class="flex justify-center space-x-2 space-x-reverse">
                <button @click="isDeleteModalOpen = false" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">انصراف</button>
                <button @click="deleteCategory()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">بله، حذف کن</button>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('categoryManager', () => ({
        isModalOpen: false,
        isDeleteModalOpen: false,
        isEditMode: false,
        modalTitle: '',
        currentCategory: { id: null, title: '', color_code: '' },
        
        // --- این خط اصلاح شده است ---
        categories: {{ categories_json|safe }},

        notify(message, type = 'success') {
            window.dispatchEvent(new CustomEvent('notify', { detail: { message, type } }));
        },

        getCSRFToken() {
            // ... بقیه کد جاوا اسکریپت شما بدون تغییر ...
            return document.querySelector('form input[name="csrfmiddlewaretoken"]').value;
        },

        openAddModal() {
            this.isEditMode = false;
            this.modalTitle = 'افزودن دسته‌بندی جدید';
            this.currentCategory = { id: null, title: '', color_code: '' };
            document.querySelector('#id_title').value = '';
            document.querySelector('#id_color_code').value = '';
            this.isModalOpen = true;
        },

        openEditModal(category) {
            this.isEditMode = true;
            this.modalTitle = 'ویرایش دسته‌بندی';
            this.currentCategory = { ...category };
            document.querySelector('#id_title').value = category.title;
            document.querySelector('#id_color_code').value = category.color_code;
            this.isModalOpen = true;
        },
        
        openDeleteModal(category) {
            this.currentCategory = category;
            this.isDeleteModalOpen = true;
        },
        
        closeModal() {
            this.isModalOpen = false;
        },

        saveCategory() {
            const titleInput = document.querySelector('#id_title');
            const colorInput = document.querySelector('#id_color_code');
            const formData = new FormData();
            formData.append('title', titleInput.value);
            formData.append('color_code', colorInput.value);

            const url = this.isEditMode 
                ? `{% url 'dashboard:categories:category_update' 0 %}`.replace('0', this.currentCategory.id) 
                : `{% url 'dashboard:categories:category_create' %}`;
            
            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': this.getCSRFToken() },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    if(this.isEditMode) {
                        const index = this.categories.findIndex(c => c.id === data.category.id);
                        this.categories[index] = data.category;
                    } else {
                        this.categories.push(data.category);
                    }
                    this.notify(data.message, 'success'); // <-- نمایش پیام موفقیت
                    this.closeModal();
                } else {
                    this.notify(data.message, 'error'); // <-- نمایش پیام خطا
                }
            });
        },

        deleteCategory() {
            const url = `{% url 'dashboard:categories:category_delete' 0 %}`.replace('0', this.currentCategory.id);
            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': this.getCSRFToken() }
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    this.categories = this.categories.filter(c => c.id !== this.currentCategory.id);
                    this.notify(data.message, 'success');
                    this.isDeleteModalOpen = false;
                } else {
                    this.notify(data.message, 'error');
                }
            });
        }
    }));
});
</script>
{% endblock %}