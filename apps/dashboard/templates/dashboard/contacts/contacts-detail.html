{% extends 'dashboard/base.html' %}

{% block title %}مشاهده پیام - دکتر کد{% endblock %}

{% block content %}
<main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-4 sm:p-6 lg:p-8" 
    x-data="{ 
        replyFormVisible: false,
        adminResponse: '',
        showDeleteModal: false
    }">
    <div class="container mx-auto max-w-4xl">

        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <a href="{% url 'dashboard:contacts:contacts_list' %}" class="inline-flex items-center text-sm font-semibold text-slate-600 hover:text-blue-600 transition-colors">
                <svg class="h-5 w-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3" /></svg>
                <span>بازگشت به لیست پیام‌ها</span>
            </a>
            <div class="flex items-center space-x-2 space-x-reverse">
                {% if not contact.admin_response %}
                <button @click="replyFormVisible = true" class="p-2 flex items-center bg-white border border-slate-300 rounded-lg text-sm text-slate-700 hover:bg-slate-50 transition-colors">
                    <svg class="h-5 w-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg>
                    <span>پاسخ دادن</span>
                </button>
                {% endif %}
                
                {% if contact.status != 'closed' %}
                <form method="POST" action="{% url 'dashboard:contacts:contact_mark_read' contact.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="p-2 bg-white border border-slate-300 rounded-lg text-slate-500 hover:text-green-600 hover:bg-green-50 transition-colors" title="بستن پیام">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </button>
                </form>
                {% endif %}
                
                <button @click="showDeleteModal = true" class="p-2 bg-white border border-slate-300 rounded-lg text-slate-500 hover:text-red-600 hover:bg-red-50 transition-colors" title="حذف پیام">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-200 relative">
                <h2 class="text-xl font-bold text-slate-800">{{ contact.subject_display }}</h2>
                
                <!-- نمایش وضعیت با رنگ‌بندی مناسب -->
                <div class="absolute top-4 left-4">
                    {% if contact.status == 'pending' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        در انتظار بررسی
                    </span>
                    {% elif contact.status == 'in_progress' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        در حال بررسی
                    </span>
                    {% elif contact.status == 'answered' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        پاسخ داده شده
                    </span>
                    {% elif contact.status == 'closed' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        بسته شده
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 bg-slate-50">
                <div>
                    <span class="text-sm text-slate-500">از:</span>
                    <span class="font-semibold">{{ contact.full_name }}</span>
                    <span class="text-sm text-slate-400">&lt;{{ contact.email }}&gt;</span>
                    {% if contact.phone_number %}
                    <span class="text-sm text-slate-400"> - {{ contact.phone_number }}</span>
                    {% endif %}
                </div>
                <div class="text-sm text-slate-500">{{ contact.created_at|date:"l، j F Y - ساعت H:i" }}</div>
            </div>
            
            <div class="p-6 leading-relaxed text-slate-700 prose prose-sm max-w-none">
                {{ contact.message|linebreaksbr }}
            </div>
            
            {% if contact.admin_response %}
            <div class="p-6 bg-green-50 border-t border-green-200">
                <h3 class="text-lg font-semibold text-green-800 mb-3">پاسخ ادمین:</h3>
                <div class="text-green-700 leading-relaxed">
                    {{ contact.admin_response|linebreaksbr }}
                </div>
                <div class="mt-3 text-sm text-green-600">
                    پاسخ داده شده توسط {{ contact.responded_by.get_full_name|default:contact.responded_by.phone_number }} در {{ contact.responded_at|date:"j F Y - ساعت H:i" }}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- فرم پاسخ -->
        <div x-show="replyFormVisible" x-cloak x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-4" class="mt-8">
            <div class="bg-white rounded-xl shadow-sm">
                <div class="p-6 border-b border-slate-200">
                    <h3 class="text-lg font-semibold">پاسخ به {{ contact.full_name }}</h3>
                </div>
                <form method="POST">
                    {% csrf_token %}
                    <div class="p-6 space-y-4">
                        <div class="flex items-center">
                            <label class="w-16 text-sm text-slate-500">به:</label>
                            <input type="text" value="{{ contact.email }}" readonly class="w-full p-2 bg-slate-100 border border-slate-200 rounded-md text-sm text-slate-600">
                        </div>
                        <div class="flex items-center">
                            <label class="w-16 text-sm text-slate-500">موضوع:</label>
                            <input type="text" value="پاسخ: {{ contact.subject_display }}" readonly class="w-full p-2 bg-slate-100 border border-slate-200 rounded-md text-sm text-slate-600">
                        </div>
                        <div class="border border-slate-200 rounded-lg">
                            <textarea name="admin_response" x-model="adminResponse" rows="8" class="w-full p-3 text-sm focus:outline-none rounded-lg" placeholder="پاسخ خود را اینجا بنویسید..." required></textarea>
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-slate-50 rounded-b-xl flex justify-end items-center space-x-3 space-x-reverse">
                        <button type="button" @click="replyFormVisible = false" class="py-2 px-5 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">انصراف</button>
                        <button type="submit" class="py-2 px-6 text-sm font-semibold bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center">
                            <svg class="h-5 w-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
                            <span>ارسال پاسخ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- مودال حذف -->
        <div x-show="showDeleteModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" @click.away="showDeleteModal = false">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">تأیید حذف</h3>
                <p class="text-slate-600 mb-6">آیا مطمئن هستید که می‌خواهید این پیام را حذف کنید؟ این عمل قابل بازگشت نیست.</p>
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button @click="showDeleteModal = false" class="py-2 px-4 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                        انصراف
                    </button>
                    <form method="POST" action="{% url 'dashboard:contacts:contact_delete' contact.pk %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="py-2 px-4 text-sm font-semibold bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                            حذف کردن
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}
