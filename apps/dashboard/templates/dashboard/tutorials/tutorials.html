{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ{% endblock %}

{% block extra_css %}
<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div x-data="tutorialsManager()" x-init="init()">
    <div class="container mx-auto">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-slate-700">Ù…Ø¯ÛŒØ±ÛŒØª ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ</h1>
            
            <button @click="openAddModal()" 
                    class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-sm transition-colors">
                <i class="fa-solid fa-plus ml-2"></i>
                <span>Ø§ÙØ²ÙˆØ¯Ù† ÙˆÛŒØ¯ÛŒÙˆ Ø¬Ø¯ÛŒØ¯</span>
            </button>
        </div>

        <!-- Desktop Table -->
        <div class="hidden lg:block bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="min-w-full text-sm">
                <thead class="bg-slate-50 text-slate-600">
                    <tr>
                        <th scope="col" class="px-6 py-4 text-right font-medium">Ø¹Ù†ÙˆØ§Ù†</th>
                        <th scope="col" class="px-6 py-4 text-center font-medium">ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
                        <th scope="col" class="px-6 py-4 text-center font-medium">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th>
                        <th scope="col" class="px-6 py-4 text-center font-medium">ÙˆØ¶Ø¹ÛŒØª</th>
                        <th scope="col" class="px-6 py-4 text-center font-medium">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    <template x-if="filteredTutorials.length === 0">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-slate-500">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-video text-4xl mb-4 text-slate-300"></i>
                                    <p class="text-lg font-medium">Ù‡ÛŒÚ† ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                                    <p class="text-sm">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§ÙˆÙ„ÛŒÙ† ÙˆÛŒØ¯ÛŒÙˆ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p>
                                </div>
                            </td>
                        </tr>
                    </template>
                    
                    <template x-for="tutorial in filteredTutorials" :key="tutorial.id">
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap font-semibold" x-text="tutorial.title"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm" x-text="tutorial.shamsi_created_at"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm" x-text="tutorial.shamsi_updated_at"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <template x-if="isRecent(tutorial.created_at)">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fa-solid fa-star ml-1"></i>
                                        Ø¬Ø¯ÛŒØ¯
                                    </span>
                                </template>
                                <template x-if="!isRecent(tutorial.created_at)">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fa-solid fa-check ml-1"></i>
                                        ÙØ¹Ø§Ù„
                                    </span>
                                </template>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div class="flex justify-center items-center space-x-2 space-x-reverse">
                                    <button @click="openPreviewModal(tutorial)"
                                            class="p-2 text-slate-500 hover:text-blue-600 rounded-md hover:bg-slate-200 transition-colors" 
                                            title="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´">
                                        <i class="fa-solid fa-eye"></i>
                                    </button>
                                    <button @click="openEditModal(tutorial)" 
                                            class="p-2 text-slate-500 hover:text-yellow-600 rounded-md hover:bg-slate-200 transition-colors" 
                                            title="ÙˆÛŒØ±Ø§ÛŒØ´">
                                        <i class="fa-solid fa-edit"></i>
                                    </button>
                                    <button @click="deleteTutorial(tutorial.id)" 
                                            class="p-2 text-slate-500 hover:text-red-600 rounded-md hover:bg-slate-200 transition-colors" 
                                            title="Ø­Ø°Ù">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Mobile Cards -->
        <div class="grid grid-cols-1 gap-4 lg:hidden">
            <template x-if="filteredTutorials.length === 0">
                <div class="bg-white rounded-xl shadow-sm p-8 text-center">
                    <i class="fa-solid fa-video text-4xl mb-4 text-slate-300"></i>
                    <p class="text-lg font-medium text-slate-700 mb-2">Ù‡ÛŒÚ† ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                    <p class="text-sm text-slate-500">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§ÙˆÙ„ÛŒÙ† ÙˆÛŒØ¯ÛŒÙˆ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p>
                </div>
            </template>
            
            <template x-for="tutorial in filteredTutorials" :key="tutorial.id">
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-800 mb-2" x-text="tutorial.title"></h3>
                            <div class="space-y-2">
                                <p class="text-sm text-slate-600">
                                    Ø§ÛŒØ¬Ø§Ø¯: <span class="font-medium" x-text="tutorial.shamsi_created_at"></span>
                                </p>
                                <p class="text-sm text-slate-600">
                                    Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span class="font-medium" x-text="tutorial.shamsi_updated_at"></span>
                                </p>
                                <div class="flex items-center">
                                    <template x-if="isRecent(tutorial.created_at)">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fa-solid fa-star ml-1"></i>
                                            Ø¬Ø¯ÛŒØ¯
                                        </span>
                                    </template>
                                    <template x-if="!isRecent(tutorial.created_at)">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            <i class="fa-solid fa-check ml-1"></i>
                                            ÙØ¹Ø§Ù„
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-center space-y-2">
                            <button @click="openPreviewModal(tutorial)"
                                    class="p-2 text-slate-500 hover:text-blue-600 rounded-md hover:bg-slate-100 transition-colors" 
                                    title="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                            <button @click="openEditModal(tutorial)" 
                                    class="p-2 text-slate-500 hover:text-yellow-600 rounded-md hover:bg-slate-100 transition-colors" 
                                    title="ÙˆÛŒØ±Ø§ÛŒØ´">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button @click="deleteTutorial(tutorial.id)" 
                                    class="p-2 text-slate-500 hover:text-red-600 rounded-md hover:bg-slate-100 transition-colors" 
                                    title="Ø­Ø°Ù">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Modal -->
    <div x-show="isModalOpen" 
         x-cloak 
         @keydown.escape.window="closeModal()"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto">
        
        <!-- Backdrop -->
        <div class="flex min-h-screen items-center justify-center p-4">
            <div @click="closeModal()" 
                 class="fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm"></div>
            
            <!-- Modal Container -->
            <div x-show="isModalOpen"
                 @click.stop
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95"
                 class="relative z-10 w-full max-w-md md:max-w-3xl lg:max-w-4xl bg-white rounded-xl shadow-2xl my-8 flex flex-col max-h-[90vh]">
                
                <!-- Modal Header -->
                <div class="flex-shrink-0 p-5 md:p-6 flex justify-between items-center border-b border-slate-200 bg-white rounded-t-xl">
                    <div class="flex items-center">
                        <div class="hidden md:block w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center ml-3">
                            <i class="fa-solid fa-video text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-bold text-slate-800" x-text="modalTitle"></h3>
                            <p class="text-sm text-slate-500 hidden md:block">Ù…Ø¯ÛŒØ±ÛŒØª ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø³ÛŒØ³ØªÙ…</p>
                        </div>
                    </div>
                    <button @click="closeModal()" 
                            class="p-2 text-slate-400 hover:text-slate-700 rounded-full hover:bg-slate-100 transition-colors">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="flex-1 overflow-y-auto p-6 md:p-8">
                    <template x-if="currentModalType === 'form'">
                        <form @submit.prevent="submitForm()" id="tutorialForm">
                            <!-- Ø¹Ù†ÙˆØ§Ù† -->
                            <div class="form-field mb-6">
                                <label for="t-title" class="block text-sm font-semibold text-slate-700 mb-3">
                                    <i class="fa-solid fa-heading ml-2 text-blue-500"></i>
                                    Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯ÛŒÙˆ
                                </label>
                                <input type="text" 
                                       id="t-title" 
                                       x-model="formData.title" 
                                       placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯ÛŒÙˆ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" 
                                       required
                                       class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200 hover:border-slate-400">
                                <template x-if="errors.title">
                                    <p class="mt-2 text-sm text-red-600" x-text="errors.title[0]"></p>
                                </template>
                            </div>

                            <!-- Ú©Ø¯ Embed Ø¢Ù¾Ø§Ø±Ø§Øª -->
                            <div class="form-field mb-6">
                                <label for="t-aparat" class="block text-sm font-semibold text-slate-700 mb-3">
                                    <i class="fa-solid fa-code ml-2 text-green-500"></i>
                                    Ú©Ø¯ Embed Ø¢Ù¾Ø§Ø±Ø§Øª
                                </label>
                                <textarea id="t-aparat" 
                                          x-model="formData.aparat_url" 
                                          rows="6"
                                          placeholder='<script type="text/JavaScript" src="https://www.aparat.com/embed/..."></script>'
                                          required
                                          class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent font-mono text-sm transition-all duration-200 hover:border-slate-400"
                                          dir="ltr"></textarea>
                                <p class="mt-2 text-xs text-slate-500 flex items-center">
                                    <i class="fa-solid fa-lightbulb ml-1 text-yellow-500"></i>
                                    Ú©Ø¯ embed Ø±Ø§ Ø§Ø² Ø¢Ù¾Ø§Ø±Ø§Øª Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
                                </p>
                                <template x-if="errors.aparat_url">
                                    <p class="mt-2 text-sm text-red-600" x-text="errors.aparat_url[0]"></p>
                                </template>
                            </div>
                        </form>
                    </template>

                    <!-- Preview -->
                    <template x-if="currentModalType === 'preview'">
                        <div>
                            <div id="preview-video-container" class="relative w-full bg-black rounded-lg overflow-hidden" style="padding-bottom: 56.25%;">
                                <!-- Ú©Ø¯ embed Ø§ÛŒÙ†Ø¬Ø§ inject Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Modal Footer -->
                <div class="flex-shrink-0 border-t border-slate-200 px-6 md:px-8 py-4 bg-slate-50 rounded-b-xl">
                    <div class="flex flex-col-reverse md:flex-row justify-end items-center gap-3">
                        <button type="button" 
                                @click="closeModal()" 
                                class="w-full md:w-auto py-3 md:py-2.5 px-6 text-sm font-semibold bg-white border-2 border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 hover:border-slate-400 transition-all duration-200">
                            <i class="fa-solid fa-times ml-2"></i>
                            <span x-text="currentModalType === 'preview' ? 'Ø¨Ø³ØªÙ†' : 'Ø§Ù†ØµØ±Ø§Ù'"></span>
                        </button>
                        <template x-if="currentModalType === 'form'">
                            <button type="submit" 
                                    form="tutorialForm"
                                    :disabled="isLoading"
                                    class="w-full md:w-auto py-3 md:py-2.5 px-8 text-sm font-semibold bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <span x-show="!isLoading" class="flex items-center justify-center">
                                    <i class="fa-solid fa-save ml-2"></i>
                                    <span x-text="isEditMode ? 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆÛŒØ¯ÛŒÙˆ' : 'Ø§ÛŒØ¬Ø§Ø¯ ÙˆÛŒØ¯ÛŒÙˆ'"></span>
                                </span>
                                <span x-show="isLoading" class="flex items-center justify-center">
                                    <i class="fa-solid fa-spinner fa-spin ml-2"></i>
                                    Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...
                                </span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function tutorialsManager() {
    return {
        // State
        tutorials: [],
        filteredTutorials: [],
        selectedTutorial: null,
        isModalOpen: false,
        isEditMode: false,
        isLoading: false,
        modalTitle: '',
        currentModalType: 'form', // 'form' or 'preview'
        errors: {},
        
        // Forms
        formData: {
            title: '',
            aparat_url: ''
        },
        
        // Initialize
        init() {
            console.log('ğŸš€ Initializing tutorials manager...');
            
            try {
                const tutorialsData = JSON.parse('{{ tutorials_json|escapejs }}');
                console.log('ğŸ“¦ Raw tutorials data:', tutorialsData);
                
                if (Array.isArray(tutorialsData)) {
                    this.tutorials = tutorialsData;
                    this.filteredTutorials = [...this.tutorials];
                    console.log(`âœ… Successfully loaded ${this.tutorials.length} tutorials`);
                } else {
                    console.error('âŒ Tutorials data is not an array:', typeof tutorialsData);
                    this.tutorials = [];
                    this.filteredTutorials = [];
                }
            } catch (error) {
                console.error('âŒ Error loading tutorials:', error);
                this.tutorials = [];
                this.filteredTutorials = [];
            }
        },
        
        // Check if tutorial is recent (within last 7 days)
        isRecent(dateString) {
            const tutorialDate = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - tutorialDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 7;
        },
        
        // Modal management
        openAddModal() {
            console.log('â• Opening add modal');
            this.resetForm();
            this.isModalOpen = true;
            this.isEditMode = false;
            this.currentModalType = 'form';
            this.modalTitle = 'Ø§ÙØ²ÙˆØ¯Ù† ÙˆÛŒØ¯ÛŒÙˆ Ø¬Ø¯ÛŒØ¯';
        },
        
        async openEditModal(tutorial) {
            console.log('ğŸ“ Opening edit modal for:', tutorial);
            this.selectedTutorial = { ...tutorial };
            this.formData = {
                title: tutorial.title || '',
                aparat_url: ''
            };
            this.errors = {};
            this.isEditMode = true;
            this.currentModalType = 'form';
            this.modalTitle = 'ÙˆÛŒØ±Ø§ÛŒØ´ ÙˆÛŒØ¯ÛŒÙˆ';
            
            // Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ embed Ø§Ø² Ø³Ø±ÙˆØ±
            try {
                const response = await fetch(`/dashboard/admin/tutorials/embed/${tutorial.id}/`, {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.formData.aparat_url = data.aparat_url;
                    console.log('âœ… Embed code loaded successfully');
                } else {
                    console.error('âŒ Failed to load embed code');
                    this.showNotification('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø¯ embed');
                }
            } catch (error) {
                console.error('âŒ Error loading embed code:', error);
                this.showNotification('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø¯ embed');
            }
            
            this.isModalOpen = true;
        },
        
        async openPreviewModal(tutorial) {
            console.log('ğŸ‘ï¸ Opening preview modal for:', tutorial);
            this.selectedTutorial = { ...tutorial };
            this.currentModalType = 'preview';
            this.modalTitle = tutorial.title;
            
            // Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ embed Ø§Ø² Ø³Ø±ÙˆØ±
            try {
                const response = await fetch(`/dashboard/admin/tutorials/embed/${tutorial.id}/`, {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.isModalOpen = true;
                    
                    // Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø§Ø² Ø´Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ØŒ Ú©Ø¯ embed Ø±Ø§ inject Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    this.$nextTick(() => {
                        const container = document.getElementById('preview-video-container');
                        if (container) {
                            container.innerHTML = data.aparat_url;
                            console.log('âœ… Embed code injected successfully');
                        }
                    });
                } else {
                    console.error('âŒ Failed to load embed code');
                    this.showNotification('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒØ¯ÛŒÙˆ');
                }
            } catch (error) {
                console.error('âŒ Error loading embed code:', error);
                this.showNotification('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒØ¯ÛŒÙˆ');
            }
        },
        
        closeModal() {
            console.log('âŒ Closing modal');
            this.isModalOpen = false;
            this.selectedTutorial = null;
            this.errors = {};
            this.currentModalType = 'form';
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† video container
            const container = document.getElementById('preview-video-container');
            if (container) {
                container.innerHTML = '';
            }
        },
        
        resetForm() {
            this.formData = {
                title: '',
                aparat_url: ''
            };
            this.selectedTutorial = null;
            this.isLoading = false;
            this.errors = {};
        },
        
        // CRUD Operations
        async submitForm() {
            console.log('ğŸ’¾ Submitting form...');
            this.isLoading = true;
            this.errors = {};
            
            const url = this.isEditMode 
                ? `/dashboard/admin/tutorials/${this.selectedTutorial.id}/update/`
                : '/dashboard/admin/tutorials/create/';
            
            const method = this.isEditMode ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(this.formData)
                });
                
                const data = await response.json();
                console.log('ğŸ“¨ Server response:', data);
                
                if (data.success) {
                    if (this.isEditMode) {
                        const index = this.tutorials.findIndex(t => t.id === this.selectedTutorial.id);
                        if (index !== -1) {
                            this.tutorials[index] = data.tutorial;
                        }
                    } else {
                        this.tutorials.unshift(data.tutorial);
                    }
                    this.filteredTutorials = [...this.tutorials];
                    this.closeModal();
                    this.showNotification('success', data.message);
                    console.log('âœ… Operation successful');
                } else {
                    this.errors = data.errors || {};
                    this.showNotification('error', data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª');
                    console.error('âŒ Operation failed:', data);
                }
            } catch (error) {
                console.error('âŒ Error:', error);
                this.showNotification('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            } finally {
                this.isLoading = false;
            }
        },
        
        async deleteTutorial(id) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                return;
            }

            console.log('ğŸ—‘ï¸ Deleting tutorial...');
            
            try {
                const response = await fetch(`/dashboard/admin/tutorials/${id}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                const data = await response.json();
                console.log('ğŸ“¨ Server response:', data);
                
                if (data.success) {
                    this.tutorials = this.tutorials.filter(t => t.id !== id);
                    this.filteredTutorials = [...this.tutorials];
                    this.showNotification('success', data.message);
                    console.log('âœ… Tutorial deleted successfully');
                } else {
                    this.showNotification('error', data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙˆÛŒØ¯ÛŒÙˆ');
                    console.error('âŒ Failed to delete tutorial:', data);
                }
            } catch (error) {
                console.error('âŒ Error deleting tutorial:', error);
                this.showNotification('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        },
        
        // Notification
        showNotification(type, message) {
            window.dispatchEvent(new CustomEvent('notify', {
                detail: { type, message }
            }));
        }
    }
}
</script>
{% endblock %}
