{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}
    {% if object %}ویرایش نسخه{% else %}افزودن نسخه جدید{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .drug-item {
        transition: all 0.3s ease;
    }
    .drug-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .drag-handle {
        cursor: grab;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
    .formset-item {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        background: white;
    }
    .delete-checkbox {
        display: none;
    }
    /* استایل مودال */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1000;
    }
    
    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-title {
        font-size: 1.25rem;
        font-weight: bold;
    }
    
    .close {
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-input:focus {
        outline: none;
        ring: 2px solid #3b82f6;
        border-color: #3b82f6;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }
    
    .btn-primary {
        background-color: #3b82f6;
        color: white;
        border: none;
    }
    
    .btn-primary:hover {
        background-color: #2563eb;
    }
    
    .btn-secondary {
        background-color: #6b7280;
        color: white;
        border: none;
    }
    
    .btn-secondary:hover {
        background-color: #4b5563;
    }
</style>
{{ form.media.css }}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="bg-white shadow-lg rounded-lg">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">
                    {% if object %}ویرایش نسخه: {{ object.title }}{% else %}افزودن نسخه جدید{% endif %}
                </h1>
                <a href="{% url 'dashboard:prescriptions:prescription_list' %}" 
                   class="text-blue-600 hover:text-blue-800 flex items-center">
                    <i class="fas fa-arrow-right ml-2"></i>
                    بازگشت
                </a>
            </div>
        </div>

        <form id="prescriptionForm" method="post" enctype="multipart/form-data" class="p-6">
            {% csrf_token %}
            
            <!-- Hidden field for drugs data -->
            <input type="hidden" id="drugs_data" name="drugs_data" value="">
            
            {{ alias_formset.management_form }}
            {{ video_formset.management_form }}
            {{ image_formset.management_form }}

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-8">
                    
                    <!-- اطلاعات پایه -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">اطلاعات پایه</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.title.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.title.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.description.label }}
                                </label>
                                {{ form.description }}
                            </div>
                        </div>
                    </div>

                    <!-- انتخاب داروها -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">انتخاب داروها</h2>
                        
                        <!-- جستجوی دارو -->
                        <div class="mb-6">
                            <div class="relative">
                                <input type="text" 
                                       id="drugSearch" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="نام دارو را تایپ کنید...">
                                <div id="drugDropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                                    <!-- نتایج جستجو اینجا نمایش داده می‌شود -->
                                </div>
                            </div>
                            
                            <!-- دکمه افزودن دارو -->
                            <div class="mt-3">
                                <button type="button" 
                                        id="openCreateDrugModalBtn"
                                        class="w-full flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-plus ml-2"></i>
                                    افزودن داروی جدید
                                </button>
                            </div>
                        </div>

                        <!-- داروهای انتخاب شده -->
                        <div id="selectedDrugs" class="space-y-4">
                            <h3 class="text-lg font-medium text-gray-700">داروهای انتخاب شده:</h3>
                            <div id="drugsContainer" class="space-y-3">
                                <!-- داروهای انتخاب شده اینجا نمایش داده می‌شوند -->
                            </div>
                        </div>
                    </div>

                    <!-- نام‌های جایگزین -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">نام‌های جایگزین</h2>
                        <div id="aliasesContainer" class="space-y-3">
                            {% for alias_form in alias_formset %}
                                <div class="formset-item alias-form" data-form-index="{{ forloop.counter0 }}">
                                    {% for hidden in alias_form.hidden_fields %}{{ hidden }}{% endfor %}
                                    
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-medium text-gray-700">نام جایگزین #{{ forloop.counter }}</h4>
                                        <button type="button" onclick="removeFormsetItem(this, 'alias')" class="text-red-600 hover:text-red-800 text-sm">
                                            <i class="fas fa-trash ml-1"></i>حذف
                                        </button>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ alias_form.name.label }}</label>
                                            {{ alias_form.name }}
                                        </div>
                                        <div class="flex items-center">
                                            {{ alias_form.is_primary }}
                                            <label class="mr-2 text-sm text-gray-700">{{ alias_form.is_primary.label }}</label>
                                        </div>
                                    </div>
                                    
                                    <div class="delete-checkbox">{{ alias_form.DELETE }}</div>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="addAlias" class="mt-3 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            <i class="fas fa-plus ml-2"></i>افزودن نام جایگزین
                        </button>
                    </div>

                    <!-- توضیحات تفصیلی -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">توضیحات تفصیلی</h2>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.detailed_description.label }}
                            </label>
                            {{ form.detailed_description }}
                        </div>
                    </div>

                    <!-- ویدیوها -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">ویدیوهای آموزشی</h2>
                        <div id="videosContainer" class="space-y-3">
                            {% for video_form in video_formset %}
                                <div class="formset-item video-form" data-form-index="{{ forloop.counter0 }}">
                                    {% for hidden in video_form.hidden_fields %}{{ hidden }}{% endfor %}
                                    
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-medium text-gray-700">ویدیو #{{ forloop.counter }}</h4>
                                        <button type="button" onclick="removeFormsetItem(this, 'video')" class="text-red-600 hover:text-red-800 text-sm">
                                            <i class="fas fa-trash ml-1"></i>حذف
                                        </button>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ video_form.video_url.label }}</label>
                                            {{ video_form.video_url }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ video_form.title.label }}</label>
                                            {{ video_form.title }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ video_form.description.label }}</label>
                                            {{ video_form.description }}
                                        </div>
                                    </div>
                                    
                                    <div class="delete-checkbox">{{ video_form.DELETE }}</div>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="addVideo" class="mt-3 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            <i class="fas fa-plus ml-2"></i>افزودن ویدیو
                        </button>
                    </div>

                    <!-- تصاویر -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">تصاویر</h2>
                        <div id="imagesContainer" class="space-y-3">
                            {% for image_form in image_formset %}
                                <div class="formset-item image-form" data-form-index="{{ forloop.counter0 }}">
                                    {% for hidden in image_form.hidden_fields %}{{ hidden }}{% endfor %}
                                    
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-medium text-gray-700">تصویر #{{ forloop.counter }}</h4>
                                        <button type="button" onclick="removeFormsetItem(this, 'image')" class="text-red-600 hover:text-red-800 text-sm">
                                            <i class="fas fa-trash ml-1"></i>حذف
                                        </button>
                                    </div>
                                    
                                    {% if image_form.instance.image %}
                                        <div class="mb-3">
                                            <img src="{{ image_form.instance.image.url }}" alt="تصویر" class="w-32 h-32 object-cover rounded border">
                                        </div>
                                    {% endif %}
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ image_form.image.label }}</label>
                                            {{ image_form.image }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ image_form.caption.label }}</label>
                                            {{ image_form.caption }}
                                        </div>
                                    </div>
                                    
                                    <div class="delete-checkbox">{{ image_form.DELETE }}</div>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="addImage" class="mt-3 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            <i class="fas fa-plus ml-2"></i>افزودن تصویر
                        </button>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- تنظیمات انتشار -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">انتشار</h3>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                {{ form.is_active }}
                                <label class="mr-2 text-sm">{{ form.is_active.label }}</label>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                                {% if object %}بروزرسانی نسخه{% else %}ایجاد نسخه{% endif %}
                            </button>
                        </div>
                    </div>

                    <!-- تنظیمات -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">تنظیمات</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.category.label }}
                                </label>
                                {{ form.category }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    {{ form.access_level.label }}
                                </label>
                                {{ form.access_level }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- مودال ایجاد دارو -->
<div id="createDrugModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">ایجاد داروی جدید</h2>
            <span id="closeCreateDrugModal" class="close">&times;</span>
        </div>
        <form id="createDrugForm">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_title" class="form-label">نام دارو</label>
                <input type="text" name="title" id="id_title" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="id_code" class="form-label">کد دارو (اختیاری)</label>
                <input type="text" name="code" id="id_code" class="form-input">
            </div>
            <div class="flex justify-end space-x-2 space-x-reverse">
                <button type="button" id="closeCreateDrugModalBtn" class="btn btn-secondary">انصراف</button>
                <button type="submit" class="btn btn-primary">ایجاد دارو</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media.js }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // داده‌های اولیه
    const allDrugs = {{ all_drugs_json|safe }};
    const existingDrugs = {% if existing_drugs_json %}{{ existing_drugs_json|safe }}{% else %}[]{% endif %};
    const drugGroups = {% if drug_groups_json %}{{ drug_groups_json|safe }}{% else %}[]{% endif %};
    
    let selectedDrugs = [];
    let drugCounter = 0;
    let aliasCounter = {{ alias_formset.forms|length }};
    let videoCounter = {{ video_formset.forms|length }};
    let imageCounter = {{ image_formset.forms|length }};
    
    // عناصر DOM
    const drugSearch = document.getElementById('drugSearch');
    const drugDropdown = document.getElementById('drugDropdown');
    const drugsContainer = document.getElementById('drugsContainer');
    const prescriptionForm = document.getElementById('prescriptionForm');
    
    // متغیرهای مودال ایجاد دارو
    const createDrugModal = document.getElementById('createDrugModal');
    const openCreateDrugModalBtn = document.getElementById('openCreateDrugModalBtn');
    const closeCreateDrugModalBtn = document.getElementById('closeCreateDrugModal');
    const closeCreateDrugModalBtn2 = document.getElementById('closeCreateDrugModalBtn');
    const createDrugForm = document.getElementById('createDrugForm');
    
    // تابع برای باز کردن مودال
    function openModal() {
        createDrugModal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // جلوگیری از اسکرول صفحه
    }
    
    // تابع برای بستن مودال
    function closeModal() {
        createDrugModal.style.display = 'none';
        document.body.style.overflow = 'auto'; // فعال کردن اسکرول صفحه
        createDrugForm.reset();
    }
    
    // مدیریت Formset ها
    const formsetManagers = {
        alias: {
            container: document.getElementById('aliasesContainer'),
            counter: aliasCounter,
            prefix: 'aliases',
            addButton: document.getElementById('addAlias'),
            template: createAliasTemplate
        },
        video: {
            container: document.getElementById('videosContainer'),
            counter: videoCounter,
            prefix: 'videos',
            addButton: document.getElementById('addVideo'),
            template: createVideoTemplate
        },
        image: {
            container: document.getElementById('imagesContainer'),
            counter: imageCounter,
            prefix: 'images',
            addButton: document.getElementById('addImage'),
            template: createImageTemplate
        }
    };

    // بارگیری داروهای موجود در حالت ویرایش
    function loadExistingDrugs() {
        if (existingDrugs.length > 0) {
            existingDrugs.forEach(drug => {
                addDrugToList({
                    id: drug.drug_id,
                    title: drug.drug_title,
                    code: drug.drug_code
                }, {
                    dosage: drug.dosage,
                    amount: drug.amount,
                    instructions: drug.instructions,
                    is_combination: drug.is_combination,
                    is_substitute: drug.is_substitute,
                    order: drug.order,
                    group_number: drug.group_number
                });
            });
        }
        updateEmptyState();
    }
    
    // جستجوی دارو
    drugSearch.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        
        if (searchTerm.length < 2) {
            drugDropdown.classList.add('hidden');
            return;
        }
        
        const filteredDrugs = allDrugs.filter(drug => 
            drug.title.includes(searchTerm) || 
            (drug.code && drug.code.includes(searchTerm))
        ).filter(drug => 
            !selectedDrugs.some(selected => selected.drug_id === drug.id)
        );
        
        displaySearchResults(filteredDrugs);
    });
    
    // نمایش نتایج جستجو
    function displaySearchResults(drugs) {
        if (drugs.length === 0) {
            drugDropdown.innerHTML = `
                <div class="p-3 text-gray-500 text-center">نتیجه‌ای یافت نشد</div>
                <div class="p-2 border-t border-gray-200">
                    <button type="button" class="open-create-drug-modal w-full text-center py-2 text-blue-600 hover:text-blue-800 text-sm">
                        + ایجاد داروی جدید
                    </button>
                </div>
            `;
            drugDropdown.classList.remove('hidden');
            
            // اضافه کردن event listener برای دکمه جدید
            attachModalListeners();
            return;
        }
        
        drugDropdown.innerHTML = drugs.map(drug => `
            <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100" 
                 onclick="selectDrug(${drug.id}, '${escapeHtml(drug.title)}', '${escapeHtml(drug.code || '')}')">
                <div class="font-medium">${escapeHtml(drug.title)}</div>
                ${drug.code ? `<div class="text-sm text-gray-500">کد: ${escapeHtml(drug.code)}</div>` : ''}
            </div>
        `).join('') + `
            <div class="p-2 border-t border-gray-200">
                <button type="button" class="open-create-drug-modal w-full text-center py-2 text-blue-600 hover:text-blue-800 text-sm">
                    + ایجاد داروی جدید
                </button>
            </div>
        `;
        
        drugDropdown.classList.remove('hidden');
        
        // اضافه کردن event listener برای دکمه جدید
        attachModalListeners();
    }
    
    // تابع جداگانه برای اضافه کردن event listener به دکمه‌های مودال
    function attachModalListeners() {
        const modalButtons = document.querySelectorAll('.open-create-drug-modal');
        modalButtons.forEach(btn => {
            btn.removeEventListener('click', handleOpenModal); // حذف listener قبلی
            btn.addEventListener('click', handleOpenModal);
        });
    }
    
    // handler برای باز کردن مودال
    function handleOpenModal() {
        drugDropdown.classList.add('hidden');
        document.getElementById('id_title').value = drugSearch.value;
        openModal();
    }
    
    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // انتخاب دارو
    window.selectDrug = function(id, title, code) {
        const drugData = { id, title, code };
        // محاسبه مرتبه قبل از ساخت شیء
        const nextOrder = selectedDrugs.length + 1;
        const drugDetails = {
            dosage: '',
            amount: 1,
            instructions: '',
            is_combination: false,
            is_substitute: false,
            order: nextOrder
        };
        
        addDrugToList(drugData, drugDetails);
        drugSearch.value = '';
        drugDropdown.classList.add('hidden');
        updateEmptyState();
    };
    
    // اضافه کردن دارو به لیست
    function addDrugToList(drugData, drugDetails) {
        const drugId = `drug_${drugCounter++}`;
        
        selectedDrugs.push({
            id: drugId,
            drug_id: drugData.id,
            title: drugData.title,
            code: drugData.code,
            dosage: drugDetails.dosage,
            amount: drugDetails.amount,
            instructions: drugDetails.instructions,
            is_combination: drugDetails.is_combination,
            is_substitute: drugDetails.is_substitute,
            order: drugDetails.order,
            group_number: drugDetails.group_number || null
        });
        
        const drugElement = createDrugElement(drugId, drugData, drugDetails);
        drugsContainer.appendChild(drugElement);
    }
    
    // ایجاد عنصر دارو
    function createDrugElement(drugId, drugData, drugDetails) {
        const div = document.createElement('div');
        div.className = 'drug-item bg-white border border-gray-200 rounded-lg p-4';
        div.dataset.drugId = drugId;
        
        div.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center space-x-reverse space-x-3">
                    <span class="drag-handle text-gray-400 hover:text-gray-600">
                        <i class="fas fa-grip-vertical"></i>
                    </span>
                    <div>
                        <h4 class="font-medium text-gray-900">${escapeHtml(drugData.title)}</h4>
                        ${drugData.code ? `<span class="text-sm text-gray-500">کد: ${escapeHtml(drugData.code)}</span>` : ''}
                        ${drugDetails.group_number ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">گروه ${drugDetails.group_number}</span>` : ''}
                    </div>
                </div>
                <button type="button" onclick="removeDrug('${drugId}')" 
                        class="text-red-600 hover:text-red-800 p-2 rounded hover:bg-red-50">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">دوز و نحوه مصرف</label>
                    <input type="text" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="مثال: روزی 3 بار"
                        value="${escapeHtml(drugDetails.dosage)}"
                        onchange="updateDrugDetail('${drugId}', 'dosage', this.value)">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">مقدار</label>
                    <input type="number" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        min="1"
                        value="${drugDetails.amount}"
                        onchange="updateDrugDetail('${drugId}', 'amount', parseInt(this.value))">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ترتیب نمایش</label>
                    <input type="number" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        min="1"
                        value="${drugDetails.order}"
                        onchange="updateDrugDetail('${drugId}', 'order', parseInt(this.value))">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">شماره گروه</label>
                    <input type="number" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        min="1"
                        placeholder="شماره گروه (اختیاری)"
                        value="${drugDetails.group_number || ''}"
                        onchange="updateDrugDetail('${drugId}', 'group_number', this.value ? parseInt(this.value) : null)">
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" 
                        ${drugDetails.is_combination ? 'checked' : ''}
                        onchange="updateDrugDetail('${drugId}', 'is_combination', this.checked)"
                        class="form-checkbox h-4 w-4 text-blue-600 ml-2">
                    <label class="text-sm text-gray-700">دارو ترکیبی است</label>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" 
                        ${drugDetails.is_substitute ? 'checked' : ''}
                        onchange="updateDrugDetail('${drugId}', 'is_substitute', this.checked)"
                        class="form-checkbox h-4 w-4 text-blue-600 ml-2">
                    <label class="text-sm text-gray-700">داروی جایگزین</label>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">توضیحات اضافی</label>
                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="توضیحات نحوه مصرف"
                            onchange="updateDrugDetail('${drugId}', 'instructions', this.value)">${escapeHtml(drugDetails.instructions)}</textarea>
                </div>
            </div>
        `;
        
        return div;
    }
    
    // بروزرسانی جزئیات دارو
    window.updateDrugDetail = function(drugId, field, value) {
        const drug = selectedDrugs.find(d => d.id === drugId);
        if (drug) {
            // اطمینان از اینکه مقادیر بولین به درستی پردازش می‌شوند
            if (field === 'is_combination' || field === 'is_substitute') {
                drug[field] = Boolean(value);
            } else {
                drug[field] = value;
            }
        }
    };
    
    // حذف دارو
    window.removeDrug = function(drugId) {
        selectedDrugs = selectedDrugs.filter(d => d.id !== drugId);
        const element = document.querySelector(`[data-drug-id="${drugId}"]`);
        if (element) {
            element.remove();
        }
        updateEmptyState();
    };
    
    // بروزرسانی وضعیت خالی
    function updateEmptyState() {
        if (selectedDrugs.length === 0) {
            drugsContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-pills text-3xl mb-3"></i>
                    <p>هنوز داروی انتخاب شده‌ای ندارید</p>
                    <p class="text-sm">از بخش جستجو، داروهای مورد نظر را انتخاب کنید</p>
                </div>
            `;
        }
    }
    
    // Templates برای formset ها
    function createAliasTemplate(index) {
        return `
            <div class="formset-item alias-form" data-form-index="${index}">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-medium text-gray-700">نام جایگزین #${index + 1}</h4>
                    <button type="button" onclick="removeFormsetItem(this, 'alias')" class="text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash ml-1"></i>حذف
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">نام جایگزین</label>
                        <input type="text" name="aliases-${index}-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="نام جایگزین">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="aliases-${index}-is_primary" value="on" class="form-checkbox h-4 w-4 text-blue-600 ml-2">
                        <label class="text-sm text-gray-700">اصلی</label>
                    </div>
                </div>
                
                <input type="hidden" name="aliases-${index}-id" value="">
                <div class="delete-checkbox">
                    <input type="checkbox" name="aliases-${index}-DELETE" class="form-checkbox h-4 w-4 text-red-600">
                </div>
            </div>
        `;
    }
    
    function createVideoTemplate(index) {
        return `
            <div class="formset-item video-form" data-form-index="${index}">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-medium text-gray-700">ویدیو #${index + 1}</h4>
                    <button type="button" onclick="removeFormsetItem(this, 'video')" class="text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash ml-1"></i>حذف
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">لینک ویدیو</label>
                        <input type="url" name="videos-${index}-video_url" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="https://www.aparat.com/...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">عنوان ویدیو</label>
                        <input type="text" name="videos-${index}-title" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="عنوان ویدیو">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">توضیحات</label>
                        <textarea name="videos-${index}-description" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="توضیحات ویدیو"></textarea>
                    </div>
                </div>
                
                <input type="hidden" name="videos-${index}-id" value="">
                <div class="delete-checkbox">
                    <input type="checkbox" name="videos-${index}-DELETE" class="form-checkbox h-4 w-4 text-red-600">
                </div>
            </div>
        `;
    }
    
    function createImageTemplate(index) {
        return `
            <div class="formset-item image-form" data-form-index="${index}">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-medium text-gray-700">تصویر #${index + 1}</h4>
                    <button type="button" onclick="removeFormsetItem(this, 'image')" class="text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash ml-1"></i>حذف
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">فایل تصویر</label>
                        <input type="file" name="images-${index}-image" accept="image/*" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">کپشن تصویر</label>
                        <input type="text" name="images-${index}-caption" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="کپشن تصویر">
                    </div>
                </div>
                
                <input type="hidden" name="images-${index}-id" value="">
                <div class="delete-checkbox">
                    <input type="checkbox" name="images-${index}-DELETE" class="form-checkbox h-4 w-4 text-red-600">
                </div>
            </div>
        `;
    }
    
    // افزودن فرم جدید به formset
    function addFormsetItem(type) {
        const manager = formsetManagers[type];
        const newForm = document.createElement('div');
        newForm.innerHTML = manager.template(manager.counter);
        manager.container.appendChild(newForm.firstElementChild);
        
        manager.counter++;
        updateFormsetManagementForm(type);
    }
    
    // حذف آیتم از formset
    window.removeFormsetItem = function(button, type) {
        const formItem = button.closest('.formset-item');
        const deleteCheckbox = formItem.querySelector('input[name*="-DELETE"]');
        
        if (deleteCheckbox && formItem.querySelector('input[name*="-id"]').value) {
            // آیتم موجود - فقط علامت‌گذاری برای حذف
            deleteCheckbox.checked = true;
            formItem.style.opacity = '0.5';
            formItem.style.backgroundColor = '#fee2e2';
            button.textContent = 'لغو حذف';
            button.onclick = function() { cancelDelete(button, type); };
        } else {
            // آیتم جدید - حذف کامل
            formItem.remove();
            reindexFormset(type);
        }
    };
    
    // لغو حذف
    function cancelDelete(button, type) {
        const formItem = button.closest('.formset-item');
        const deleteCheckbox = formItem.querySelector('input[name*="-DELETE"]');
        
        deleteCheckbox.checked = false;
        formItem.style.opacity = '1';
        formItem.style.backgroundColor = '';
        button.innerHTML = '<i class="fas fa-trash ml-1"></i>حذف';
        button.onclick = function() { removeFormsetItem(button, type); };
    }
    
    // تنظیم مجدد index ها
    function reindexFormset(type) {
        const manager = formsetManagers[type];
        const forms = manager.container.querySelectorAll('.formset-item');
        
        forms.forEach((form, index) => {
            form.dataset.formIndex = index;
            
            // بروزرسانی نام‌های input
            form.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.name) {
                    input.name = input.name.replace(/\d+/, index);
                }
            });
            
            // بروزرسانی عنوان
            const title = form.querySelector('h4');
            if (title) {
                title.textContent = title.textContent.replace(/#\d+/, `#${index + 1}`);
            }
        });
        
        manager.counter = forms.length;
        updateFormsetManagementForm(type);
    }
    
    // بروزرسانی فرم مدیریت
    function updateFormsetManagementForm(type) {
        const manager = formsetManagers[type];
        const totalFormsInput = document.querySelector(`#id_${manager.prefix}-TOTAL_FORMS`);
        if (totalFormsInput) {
            totalFormsInput.value = manager.counter;
        }
    }
    
    // Event listeners برای دکمه‌های افزودن
    Object.keys(formsetManagers).forEach(type => {
        const manager = formsetManagers[type];
        manager.addButton.addEventListener('click', () => addFormsetItem(type));
    });
    
    // مخفی کردن dropdown هنگام کلیک خارج از آن
    document.addEventListener('click', function(e) {
        if (!drugSearch.contains(e.target) && !drugDropdown.contains(e.target)) {
            drugDropdown.classList.add('hidden');
        }
    });
    
    // ارسال فرم
    prescriptionForm.addEventListener('submit', function(e) {
        const drugsData = selectedDrugs.map(drug => ({
            drug_id: drug.drug_id,
            dosage: drug.dosage,
            amount: drug.amount,
            instructions: drug.instructions,
            is_combination: drug.is_combination,
            is_substitute: drug.is_substitute,
            order: drug.order,
            group_number: drug.group_number
        }));
        
        document.getElementById('drugs_data').value = JSON.stringify(drugsData);
    });
    
    // مدیریت مودال ایجاد دارو
    // باز کردن مودال از دکمه اصلی
    if (openCreateDrugModalBtn) {
        openCreateDrugModalBtn.addEventListener('click', function() {
            document.getElementById('id_title').value = drugSearch.value;
            openModal();
        });
    }
    
    // بستن مودال با دکمه بستن
    if (closeCreateDrugModalBtn) {
        closeCreateDrugModalBtn.addEventListener('click', closeModal);
    }
    
    // بستن مودال با دکمه انصراف
    if (closeCreateDrugModalBtn2) {
        closeCreateDrugModalBtn2.addEventListener('click', closeModal);
    }
    
    // بستن مودال با کلیک خارج از آن
    createDrugModal.addEventListener('click', function(event) {
        if (event.target === createDrugModal) {
            closeModal();
        }
    });
    
    // ارسال فرم ایجاد دارو
    if (createDrugForm) {
        createDrugForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            
            // نمایش بارگذاری
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال ایجاد...';
            submitBtn.disabled = true;
            
            fetch("{% url 'dashboard:drugs:drug_create' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // نمایش پیام موفقیت
                    alert(data.message);
                    
                    // اضافه کردن دارو به لیست allDrugs
                    allDrugs.push({
                        id: data.drug.id,
                        title: data.drug.title,
                        code: data.drug.code
                    });
                    
                    // اضافه کردن دارو به لیست انتخاب شده‌ها
                    const drugData = {
                        id: data.drug.id,
                        title: data.drug.title,
                        code: data.drug.code
                    };
                    
                    const drugDetails = {
                        dosage: '',
                        amount: 1,
                        instructions: '',
                        is_combination: false,
                        order: selectedDrugs.length + 1
                    };
                    
                    addDrugToList(drugData, drugDetails);
                    updateEmptyState();
                    
                    // بستن مودال
                    closeModal();
                } else {
                    // نمایش خطاها
                    let errorMsg = data.message || 'خطا در ایجاد دارو';
                    if (data.errors) {
                        errorMsg += '\n' + Object.values(data.errors).flat().join('\n');
                    }
                    alert(errorMsg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در ارتباط با سرور');
            })
            .finally(() => {
                // بازگرداندن دکمه به حالت اولیه
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // بارگیری اولیه
    loadExistingDrugs();
});
</script>
<script>
        function prescriptionForm() {
            return {
                // Initial State (Static Data for Edit Mode)
                isEditMode: true,
                prescriptionTitle: 'درمان میخچه یا زگیل',
                prescriptionInstructions: 'ابتدا پا را به مدت ۵ دقیقه در آب گرم بخیسانید...',
                drugs: [
                    { id: 1, name: 'SALICYLIC ACID TOP SOL', code: '01668', dosage: 'Q12h-8h', amount: '1', description: 'توضیحات مربوط به سالیسیلیک اسید', isCombination: true },
                    { id: 2, name: 'SALICYLIC ACID', code: '01116', dosage: 'طبق دستور', amount: '20g', description: 'در صورت کوچک بودن ضایعه ۱۵ گرم', isCombination: true },
                    { id: 3, name: 'Lactic acid', code: '00729', dosage: 'طبق دستور', amount: '20g', description: 'در صورت کوچک بودن ضایعه ۱۵ گرم', isCombination: true },
                    { id: 4, name: 'Flexible collodion', code: '00351', dosage: 'طبق دستور', amount: '60g', description: '', isCombination: false },
                ],
                category: 'skin',
                isPremium: true,
                slug: 'corn-or-wart-treatment',
                videos: [
                    { url: 'https://www.aparat.com/v/example1' },
                    { url: '' }
                ],
                isDragging: false,
                uploadedFiles: [],

                init() {
                    // Initialize SortableJS on the drug list
                    const el = this.$refs.drugList;
                    new Sortable(el, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'ghost-class',
                        onEnd: (evt) => {
                            // Reorder the Alpine data array to match the DOM
                            const item = this.drugs.splice(evt.oldIndex, 1)[0];
                            this.drugs.splice(evt.newIndex, 0, item);
                        }
                    });
                },
                
                // Drug Management Methods
                addDrug() {
                    this.drugs.push({
                        id: Date.now(), // Simple unique ID
                        name: '',
                        code: '',
                        dosage: '',
                        amount: '',
                        description: '',
                        isCombination: false
                    });
                },
                removeDrug(id) {
                    this.drugs = this.drugs.filter(drug => drug.id !== id);
                },

                // Media Management Methods
                addVideo() {
                    this.videos.push({ url: '' });
                },
                removeVideo(index) {
                    this.videos.splice(index, 1);
                },
                
                // Slug Generation
                generateSlug() {
                    this.slug = (this.prescriptionTitle || '')
                        .toLowerCase()
                        .trim()
                        .replace(/[\s\W-]+/g, '-') // Replace spaces, non-word chars with a single dash
                        .replace(/--+/g, '-'); // Replace multiple dashes with a single dash
                },

                // File Uploader Logic
                handleFileSelect(event) {
                    this.addFiles(event.target.files);
                },
                handleFileDrop(event) {
                    this.isDragging = false;
                    this.addFiles(event.dataTransfer.files);
                },
                addFiles(files) {
                    Array.from(files).forEach(file => {
                        if (!file.type.startsWith('image/')) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const newFile = {
                                name: file.name,
                                size: `${(file.size / 1024).toFixed(1)} KB`,
                                preview: e.target.result,
                                progress: 0
                            };
                            this.uploadedFiles.push(newFile);
                            this.simulateUpload(newFile);
                        };
                        reader.readAsDataURL(file);
                    });
                },
                removeFile(fileName) {
                    this.uploadedFiles = this.uploadedFiles.filter(f => f.name !== fileName);
                },
                simulateUpload(file) {
                    const interval = setInterval(() => {
                        file.progress += 10;
                        if (file.progress >= 100) {
                            clearInterval(interval);
                        }
                    }, 100);
                }
            }
        }
    </script>
    
    <script>
        // در prescription_form.html - اضافه کن به انتهای script
let drugSortable = null;

// تابع برای initialize کردن sortable
function initializeDrugSortable() {
    const selectedDrugsContainer = document.getElementById('selected-drugs');
    
    if (selectedDrugsContainer && !drugSortable) {
        drugSortable = Sortable.create(selectedDrugsContainer, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            handle: '.drag-handle', // اگر handle خاصی داری
            onEnd: function(evt) {
                console.log('Drug order changed:', evt.oldIndex, '->', evt.newIndex);
                // اینجا می‌تونی order رو ذخیره کنی
                updateDrugOrder();
            }
        });
    }
}

// تابع برای به‌روزرسانی ترتیب داروها
function updateDrugOrder() {
    const drugItems = document.querySelectorAll('#selected-drugs .selected-drug-item');
    drugItems.forEach((item, index) => {
        // اگر input مخفی برای order داری
        const orderInput = item.querySelector('input[name*="order"]');
        if (orderInput) {
            orderInput.value = index + 1;
        }
        
        // یا اگر data attribute استفاده می‌کنی
        item.setAttribute('data-order', index + 1);
    });
}

// ویرایش تابع addSelectedDrug
function addSelectedDrug(drugId, drugName) {
    const selectedDrugsContainer = document.getElementById('selected-drugs');
    
    // بررسی تکراری نبودن
    if (document.querySelector(`[data-drug-id="${drugId}"]`)) {
        alert('این دارو قبلاً انتخاب شده است.');
        return;
    }

    const drugItem = document.createElement('div');
    drugItem.className = 'selected-drug-item bg-gray-50 p-3 rounded-lg border flex items-center justify-between';
    drugItem.setAttribute('data-drug-id', drugId);
    
    drugItem.innerHTML = `
        <div class="flex items-center gap-3">
            <!-- Handle برای drag کردن -->
            <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600">
                <i class="fas fa-grip-vertical"></i>
            </div>
            <span class="font-medium">${drugName}</span>
        </div>
        <button type="button" onclick="removeSelectedDrug(${drugId})" 
                class="text-red-500 hover:text-red-700">
            <i class="fas fa-times"></i>
        </button>
        <input type="hidden" name="selected_drugs" value="${drugId}">
        <input type="hidden" name="drug_order_${drugId}" value="${selectedDrugsContainer.children.length + 1}">
    `;

    selectedDrugsContainer.appendChild(drugItem);
    
    // دوباره initialize کردن sortable بعد از اضافه کردن عنصر جدید
    if (drugSortable) {
        drugSortable.destroy();
        drugSortable = null;
    }
    initializeDrugSortable();
    
    updateSelectedDrugsInput();
}

// ویرایش تابع removeSelectedDrug
function removeSelectedDrug(drugId) {
    const drugItem = document.querySelector(`[data-drug-id="${drugId}"]`);
    if (drugItem) {
        drugItem.remove();
        updateSelectedDrugsInput();
        updateDrugOrder(); // به‌روزرسانی ترتیب بعد از حذف
    }
}

// اضافه کردن CSS برای sortable
const sortableStyles = `
<style>
.sortable-ghost {
    opacity: 0.4;
    background: #f3f4f6;
}

.sortable-chosen {
    background: #e5e7eb;
}

.sortable-drag {
    background: #ffffff;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    transform: rotate(5deg);
}

.drag-handle {
    cursor: grab;
}

.drag-handle:active {
    cursor: grabbing;
}

.selected-drug-item {
    transition: all 0.2s ease;
}

.selected-drug-item:hover {
    background-color: #f9fafb;
    border-color: #d1d5db;
}
</style>
`;

// اضافه کردن styles به head
document.head.insertAdjacentHTML('beforeend', sortableStyles);

// Initialize کردن در DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    initializeDrugSortable();
});

    </script>
{% endblock %}