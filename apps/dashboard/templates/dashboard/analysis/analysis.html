{% extends 'dashboard/base.html' %}

{% block title %}تحلیل و گزارش‌گیری{% endblock %}

{% block content %}
<div x-data="analysisDashboard">
    <div class="container mx-auto">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-slate-700">تحلیل و گزارش‌گیری</h1>
            <div class="flex items-center space-x-2 space-x-reverse">
                <button @click="refreshData()" 
                        class="inline-flex items-center justify-center px-4 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 shadow-sm transition-colors">
                    <i class="fa-solid fa-refresh ml-2"></i>
                    <span>بروزرسانی</span>
                </button>
            </div>
        </div>

        <!-- بخش کاربران -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-slate-700 mb-6">آمار کاربران</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- ادمین‌ها -->
                <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-blue-700">ادمین‌ها</h3>
                        <i class="fa-solid fa-user-shield text-blue-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-blue-800 mb-2">{{ admin_count }}</p>
                    <button @click="openUserModal('admin')" 
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                        مشاهده جزئیات
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>

                <!-- کاربران عادی -->
                <div class="bg-green-50 rounded-lg p-6 border border-green-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-green-700">کاربران عادی</h3>
                        <i class="fa-solid fa-user text-green-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-green-800 mb-2">{{ regular_user_count }}</p>
                    <button @click="openUserModal('regular')" 
                            class="text-green-600 hover:text-green-800 text-sm font-medium flex items-center">
                        مشاهده جزئیات
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>

                <!-- کاربران ویژه -->
                <div class="bg-purple-50 rounded-lg p-6 border border-purple-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-purple-700">کاربران ویژه</h3>
                        <i class="fa-solid fa-crown text-purple-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-purple-800 mb-2">{{ premium_user_count }}</p>
                    <button @click="openUserModal('premium')" 
                            class="text-purple-600 hover:text-purple-800 text-sm font-medium flex items-center">
                        مشاهده جزئیات
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- بخش پرداخت‌ها -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-slate-700 mb-6">آمار پرداخت‌ها</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- کل درآمد -->
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-700">کل درآمد</h3>
                        <i class="fa-solid fa-wallet text-slate-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-slate-800">{{ total_income|floatformat:0 }} تومان</p>
                </div>

                <!-- درآمد امروز -->
                <div class="bg-orange-50 rounded-lg p-6 border border-orange-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-orange-700">درآمد امروز</h3>
                        <i class="fa-solid fa-sun text-orange-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-orange-800">{{ today_income|floatformat:0 }} تومان</p>
                </div>

                <!-- درآمد این ماه -->
                <div class="bg-red-50 rounded-lg p-6 border border-red-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-red-700">درآمد این ماه</h3>
                        <i class="fa-solid fa-calendar text-red-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-red-800">{{ month_income|floatformat:0 }} تومان</p>
                </div>
            </div>

            <!-- نمودار درآمد -->
            <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4 sm:mb-0">نمودار درآمد</h3>
                    <div class="flex space-x-2 space-x-reverse">
                        <button @click="loadChartData('income', 'daily')" 
                                :class="activeIncomeChart === 'daily' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium border border-slate-300 transition-colors">
                            روزانه
                        </button>
                        <button @click="loadChartData('income', 'weekly')" 
                                :class="activeIncomeChart === 'weekly' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium border border-slate-300 transition-colors">
                            هفتگی
                        </button>
                        <button @click="loadChartData('income', 'monthly')" 
                                :class="activeIncomeChart === 'monthly' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium border border-slate-300 transition-colors">
                            ماهانه
                        </button>
                    </div>
                </div>
                <!-- تغییرات در این قسمت: اضافه کردن container با ارتفاع ثابت -->
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- بخش اشتراک‌ها -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-bold text-slate-700 mb-6">آمار اشتراک‌ها</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- کل مشترکین -->
                <div class="bg-indigo-50 rounded-lg p-6 border border-indigo-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-indigo-700">کل مشترکین</h3>
                        <i class="fa-solid fa-users text-indigo-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-indigo-800 mb-2">{{ total_subscribers }}</p>
                    <button @click="openSubscriptionModal('subscribers')" 
                            class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                        مشاهده جزئیات
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>

                <!-- پلن‌های خریداری شده -->
                <div class="bg-pink-50 rounded-lg p-6 border border-pink-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-pink-700">پلن‌های خریداری شده</h3>
                        <i class="fa-solid fa-box-open text-pink-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-pink-800 mb-2">{{ total_plans_sold }}</p>
                    <button @click="openSubscriptionModal('plans')" 
                            class="text-pink-600 hover:text-pink-800 text-sm font-medium flex items-center">
                        مشاهده جزئیات
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>

                <!-- مشترکین جدید این ماه -->
                <div class="bg-teal-50 rounded-lg p-6 border border-teal-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-teal-700">مشترکین جدید این ماه</h3>
                        <i class="fa-solid fa-user-plus text-teal-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-teal-800">{{ new_subscribers_this_month }}</p>
                </div>
            </div>

            <!-- نمودارهای کاربران و اشتراک‌ها -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- نمودار کاربران جدید -->
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">کاربران جدید</h3>
                    <!-- تغییرات در این قسمت: اضافه کردن container با ارتفاع ثابت -->
                    <div style="position: relative; height: 250px;">
                        <canvas id="usersChart"></canvas>
                    </div>
                </div>

                <!-- نمودار اشتراک‌های جدید -->
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">اشتراک‌های جدید</h3>
                    <!-- تغییرات در این قسمت: اضافه کردن container با ارتفاع ثابت -->
                    <div style="position: relative; height: 250px;">
                        <canvas id="subscriptionsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال کاربران -->
    <div x-show="isUserModalOpen" 
         x-cloak
         @keydown.escape.window="closeUserModal()"
         class="fixed inset-0 z-50 overflow-y-auto">
        
        <div class="flex min-h-screen items-center justify-center p-4">
            <div @click="closeUserModal()" 
                 class="fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm"></div>
            
            <div class="relative z-10 w-full max-w-4xl bg-white rounded-xl shadow-2xl my-8 flex flex-col max-h-[90vh]">
                
                <!-- Header -->
                <div class="flex-shrink-0 p-6 flex justify-between items-center border-b border-slate-200 bg-white rounded-t-xl">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center ml-3">
                            <i class="fa-solid fa-users text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800" x-text="userModalTitle"></h3>
                            <p class="text-sm text-slate-500">جزئیات کاربران</p>
                        </div>
                    </div>
                    <button @click="closeUserModal()" 
                            class="p-2 text-slate-400 hover:text-slate-700 rounded-full hover:bg-slate-100 transition-colors">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="userModalContent">
                        <!-- محتوای مودال اینجا لود می‌شود -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال اشتراک‌ها -->
    <div x-show="isSubscriptionModalOpen" 
         x-cloak
         @keydown.escape.window="closeSubscriptionModal()"
         class="fixed inset-0 z-50 overflow-y-auto">
        
        <div class="flex min-h-screen items-center justify-center p-4">
            <div @click="closeSubscriptionModal()" 
                 class="fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm"></div>
            
            <div class="relative z-10 w-full max-w-6xl bg-white rounded-xl shadow-2xl my-8 flex flex-col max-h-[90vh]">
                
                <!-- Header -->
                <div class="flex-shrink-0 p-6 flex justify-between items-center border-b border-slate-200 bg-white rounded-t-xl">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center ml-3">
                            <i class="fa-solid fa-boxes text-indigo-600"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800" x-text="subscriptionModalTitle"></h3>
                            <p class="text-sm text-slate-500">جزئیات اشتراک‌ها</p>
                        </div>
                    </div>
                    <button @click="closeSubscriptionModal()" 
                            class="p-2 text-slate-400 hover:text-slate-700 rounded-full hover:bg-slate-100 transition-colors">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="subscriptionModalContent">
                        <!-- محتوای مودال اینجا لود می‌شود -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('analysisDashboard', () => ({
        // State variables
        isUserModalOpen: false,
        isSubscriptionModalOpen: false,
        userModalTitle: '',
        subscriptionModalTitle: '',
        activeIncomeChart: 'daily',
        
        // Charts
        incomeChart: null,
        usersChart: null,
        subscriptionsChart: null,

        init() {
            // Load initial chart data after a small delay to ensure DOM is ready
            setTimeout(() => {
                this.loadChartData('income', 'daily');
                this.loadChartData('users', 'daily');
                this.loadChartData('subscriptions', 'daily');
            }, 100);
        },

        // User Modal Methods
        async openUserModal(userType) {
            this.isUserModalOpen = true;
            
            const titles = {
                'admin': 'لیست ادمین‌ها',
                'regular': 'لیست کاربران عادی', 
                'premium': 'لیست کاربران ویژه'
            };
            this.userModalTitle = titles[userType] || 'جزئیات کاربران';
            
            try {
                const response = await fetch(`{% url 'dashboard:analysis:user_stats' %}?type=${userType}`);
                const data = await response.json();
                
                if (response.ok) {
                    this.renderUserModalContent(data);
                } else {
                    this.showError('خطا در دریافت اطلاعات کاربران');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showError('خطا در ارتباط با سرور');
            }
        },

        renderUserModalContent(data) {
            const container = document.getElementById('userModalContent');
            
            if (data.type === 'premium') {
                container.innerHTML = this.renderPremiumUsers(data.users);
            } else {
                container.innerHTML = this.renderRegularUsers(data.users, data.type);
            }
        },

        renderRegularUsers(users, type) {
            const headers = {
                'admin': ['نام و نام خانوادگی', 'شماره تلفن', 'ایمیل', 'تاریخ ثبت‌نام'],
                'regular': ['نام و نام خانوادگی', 'شماره تلفن', 'ایمیل', 'کد نظام پزشکی', 'تاریخ ثبت‌نام']
            };
            
            const headerCells = headers[type].map(header => 
                `<th class="px-4 py-3 text-right text-sm font-semibold text-slate-700 bg-slate-50">${header}</th>`
            ).join('');
            
            const rows = users.map(user => `
                <tr class="border-b border-slate-200 hover:bg-slate-50">
                    <td class="px-4 py-3 text-sm text-slate-700">${user.full_name}</td>
                    <td class="px-4 py-3 text-sm text-slate-700 font-mono">${user.phone_number}</td>
                    <td class="px-4 py-3 text-sm text-slate-700">${user.email}</td>
                    ${type === 'regular' ? `<td class="px-4 py-3 text-sm text-slate-700">${user.medical_code}</td>` : ''}
                    <td class="px-4 py-3 text-sm text-slate-700">${user.date_joined}</td>
                </tr>
            `).join('');
            
            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>${headerCells}</tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    ${users.length === 0 ? '<p class="text-center py-8 text-slate-500">هیچ کاربری یافت نشد</p>' : ''}
                </div>
            `;
        },

        renderPremiumUsers(users) {
            const rows = users.map(user => `
                <div class="border border-slate-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-slate-800">${user.full_name}</h4>
                            <p class="text-sm text-slate-600">${user.phone_number} • ${user.email}</p>
                        </div>
                    </div>
                    
                    ${user.active_subscription ? `
                        <div class="bg-blue-50 rounded-lg p-3 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-blue-800">پلن فعال</span>
                                <button onclick="this.parentElement.parentElement.querySelector('.plan-details').classList.toggle('hidden')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fa-solid fa-chevron-down ml-1"></i>
                                    جزئیات پلن
                                </button>
                            </div>
                            <p class="text-sm text-blue-700">${user.active_subscription.plan_name} - ${user.active_subscription.membership}</p>
                            
                            <div class="plan-details hidden mt-3 pt-3 border-t border-blue-200">
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-slate-600">قیمت:</span>
                                        <span class="font-mono font-semibold">${user.active_subscription.price} تومان</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-600">شروع:</span>
                                        <span>${user.active_subscription.start_date}</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-600">انقضا:</span>
                                        <span>${user.active_subscription.end_date}</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-600">روزهای باقی‌مانده:</span>
                                        <span class="font-semibold ${user.active_subscription.days_remaining < 7 ? 'text-red-600' : 'text-green-600'}">
                                            ${user.active_subscription.days_remaining} روز
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : '<p class="text-orange-600 text-sm">هیچ اشتراک فعالی ندارد</p>'}
                </div>
            `).join('');
            
            return `
                <div class="space-y-4">
                    ${rows}
                    ${users.length === 0 ? '<p class="text-center py-8 text-slate-500">هیچ کاربر ویژه‌ای یافت نشد</p>' : ''}
                </div>
            `;
        },

        closeUserModal() {
            this.isUserModalOpen = false;
        },

        // Subscription Modal Methods
        async openSubscriptionModal(type) {
            this.isSubscriptionModalOpen = true;
            
            const titles = {
                'subscribers': 'جزئیات مشترکین',
                'plans': 'جزئیات فروش پلن‌ها'
            };
            this.subscriptionModalTitle = titles[type] || 'جزئیات اشتراک‌ها';
            
            try {
                const response = await fetch(`{% url 'dashboard:analysis:subscription_stats' %}?type=${type}`);
                const data = await response.json();
                
                if (response.ok) {
                    this.renderSubscriptionModalContent(data, type);
                } else {
                    this.showError('خطا در دریافت اطلاعات اشتراک‌ها');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showError('خطا در ارتباط با سرور');
            }
        },

        renderSubscriptionModalContent(data, type) {
            const container = document.getElementById('subscriptionModalContent');
            
            if (type === 'subscribers') {
                container.innerHTML = this.renderSubscribersDetail(data);
            } else {
                container.innerHTML = this.renderPlansSalesDetail(data);
            }
        },

        renderSubscribersDetail(data) {
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 rounded-lg p-6 text-center">
                            <i class="fa-solid fa-users text-blue-500 text-3xl mb-3"></i>
                            <h4 class="text-lg font-semibold text-blue-700 mb-2">مشترکین این ماه</h4>
                            <p class="text-3xl font-bold text-blue-800">${data.subscribers_this_month}</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6 text-center">
                            <i class="fa-solid fa-user-friends text-green-500 text-3xl mb-3"></i>
                            <h4 class="text-lg font-semibold text-green-700 mb-2">کل مشترکین</h4>
                            <p class="text-3xl font-bold text-green-800">${data.total_subscribers}</p>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-slate-700 mb-4">روند ماهانه مشترکین جدید</h4>
                        <div class="space-y-3">
                            ${data.monthly_trend.map(item => `
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-600">${item.month}</span>
                                    <span class="font-semibold text-slate-800">${item.subscribers} مشترک</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        },

        renderPlansSalesDetail(data) {
            return `
                <div class="space-y-6">
                    ${data.membership_stats.map(membership => `
                        <div class="border border-slate-200 rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-semibold text-slate-700">${membership.membership_title}</h4>
                                <div class="text-right">
                                    <p class="text-sm text-slate-600">فروش کل: <span class="font-semibold">${membership.total_plans_sold}</span></p>
                                    <p class="text-sm text-slate-600">درآمد: <span class="font-semibold">${membership.total_revenue} تومان</span></p>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">نام پلن</th>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">مدت (روز)</th>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">قیمت (تومان)</th>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">تعداد فروش</th>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">درآمد</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${membership.plans.map(plan => `
                                            <tr class="border-b border-slate-200 hover:bg-slate-50">
                                                <td class="px-4 py-3 text-sm text-slate-700">${plan.name}</td>
                                                <td class="px-4 py-3 text-sm text-slate-700">${plan.duration_days}</td>
                                                <td class="px-4 py-3 text-sm text-slate-700 font-mono">${plan.price}</td>
                                                <td class="px-4 py-3 text-sm text-slate-700">${plan.sales_count}</td>
                                                <td class="px-4 py-3 text-sm text-slate-700 font-mono">${plan.revenue} تومان</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        },

        closeSubscriptionModal() {
            this.isSubscriptionModalOpen = false;
        },

        // Chart Methods
        async loadChartData(chartType, period) {
            try {
                const response = await fetch(`{% url 'dashboard:analysis:chart_data' %}?type=${chartType}`);
                const data = await response.json();
                
                if (response.ok) {
                    this.renderChart(chartType, data);
                    if (chartType === 'income') {
                        this.activeIncomeChart = period;
                    }
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        },

        renderChart(chartType, data) {
            const canvas = document.getElementById(`${chartType}Chart`);
            if (!canvas) {
                console.error(`Canvas element not found: ${chartType}Chart`);
                return;
            }

            const ctx = canvas.getContext('2d');
            
            // از بین بردن chart قبلی اگر وجود دارد
            if (chartType === 'income' && this.incomeChart) {
                this.incomeChart.destroy();
            } else if (chartType === 'users' && this.usersChart) {
                this.usersChart.destroy();
            } else if (chartType === 'subscriptions' && this.subscriptionsChart) {
                this.subscriptionsChart.destroy();
            }
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // این خط بسیار مهم است
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // ذخیره reference به chart
            if (chartType === 'income') {
                this.incomeChart = chart;
            } else if (chartType === 'users') {
                this.usersChart = chart;
            } else if (chartType === 'subscriptions') {
                this.subscriptionsChart = chart;
            }
        },

        // Utility Methods
        refreshData() {
            window.location.reload();
        },

        showError(message) {
            // می‌توانید از سیستم نوتیفیکیشن خود استفاده کنید
            alert(message);
        }
    }));
});
</script>

<style>
/* اضافه کردن استایل‌های لازم برای چارت‌ها */
.chart-container {
    position: relative;
    height: 300px;
}

/* اطمینان از اینکه canvasها به درستی نمایش داده می‌شوند */
canvas {
    display: block;
    max-width: 100%;
}

/* جلوگیری از overflow در کل صفحه */
.container {
    overflow-x: hidden;
}
</style>
{% endblock %}
