{% extends 'dashboard/base.html' %}
{% load humanize %}

{% block title %}ØªØ­Ù„ÛŒÙ„ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ{% endblock %}

{% block content %}
<div x-data="analysisDashboard">
    <div class="container mx-auto">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-slate-700">ØªØ­Ù„ÛŒÙ„ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ</h1>
            <div class="flex items-center space-x-2 space-x-reverse">
                <button @click="refreshData()" 
                        class="inline-flex items-center justify-center px-4 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 shadow-sm transition-colors">
                    <i class="fa-solid fa-refresh ml-2"></i>
                    <span>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</span>
                </button>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-slate-700 mb-6">Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ -->
                <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-blue-700">Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§</h3>
                        <i class="fa-solid fa-user-shield text-blue-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-blue-800 mb-2">{{ admin_count }}</p>
                    <button @click="openUserModal('admin')" 
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>

                <!-- Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ -->
                <div class="bg-green-50 rounded-lg p-6 border border-green-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-green-700">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ</h3>
                        <i class="fa-solid fa-user text-green-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-green-800 mb-2">{{ regular_user_count }}</p>
                    <button @click="openUserModal('regular')" 
                            class="text-green-600 hover:text-green-800 text-sm font-medium flex items-center">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>

                <!-- Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙˆÛŒÚ˜Ù‡ -->
                <div class="bg-purple-50 rounded-lg p-6 border border-purple-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-purple-700">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙˆÛŒÚ˜Ù‡</h3>
                        <i class="fa-solid fa-crown text-purple-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-purple-800 mb-2">{{ premium_user_count }}</p>
                    <button @click="openUserModal('premium')" 
                            class="text-purple-600 hover:text-purple-800 text-sm font-medium flex items-center">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-slate-700 mb-6">Ø¢Ù…Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯ -->
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-700">Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯</h3>
                        <i class="fa-solid fa-wallet text-slate-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-slate-800">{{ total_income|intcomma }} Ø±ÛŒØ§Ù„</p>
                </div>

                <!-- Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ² -->
                <div class="bg-orange-50 rounded-lg p-6 border border-orange-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-orange-700">Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²</h3>
                        <i class="fa-solid fa-sun text-orange-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-orange-800">{{ today_income|intcomma }} Ø±ÛŒØ§Ù„</p>
                </div>

                <!-- Ø¯Ø±Ø¢Ù…Ø¯ Ø§ÛŒÙ† Ù…Ø§Ù‡ -->
                <div class="bg-red-50 rounded-lg p-6 border border-red-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-red-700">Ø¯Ø±Ø¢Ù…Ø¯ Ø§ÛŒÙ† Ù…Ø§Ù‡</h3>
                        <i class="fa-solid fa-calendar text-red-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-red-800">{{ month_income|intcomma }} Ø±ÛŒØ§Ù„</p>
                </div>
            </div>

            <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø±Ø¢Ù…Ø¯ -->
            <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4 sm:mb-0">Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø±Ø¢Ù…Ø¯</h>
                </div>
                <!-- ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ø§ÛŒÙ† Ù‚Ø³Ù…Øª: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† container Ø¨Ø§ Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª -->
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-bold text-slate-700 mb-6">Ø¢Ù…Ø§Ø± Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Ú©Ù„ Ù…Ø´ØªØ±Ú©ÛŒÙ† -->
                <div class="bg-indigo-50 rounded-lg p-6 border border-indigo-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-indigo-700">Ú©Ù„ Ù…Ø´ØªØ±Ú©ÛŒÙ†</h3>
                        <i class="fa-solid fa-users text-indigo-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-indigo-800 mb-2">{{ total_subscribers }}</p>
                    <button @click="openSubscriptionModal('subscribers')" 
                            class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>

                <!-- Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡ -->
                <div class="bg-pink-50 rounded-lg p-6 border border-pink-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-pink-700">Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡</h3>
                        <i class="fa-solid fa-box-open text-pink-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-pink-800 mb-2">{{ total_plans_sold }}</p>
                    <button @click="openSubscriptionModal('plans')" 
                            class="text-pink-600 hover:text-pink-800 text-sm font-medium flex items-center">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </button>
                </div>

                <!-- Ù…Ø´ØªØ±Ú©ÛŒÙ† Ø¬Ø¯ÛŒØ¯ Ø§ÛŒÙ† Ù…Ø§Ù‡ -->
                <div class="bg-teal-50 rounded-lg p-6 border border-teal-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-teal-700">Ù…Ø´ØªØ±Ú©ÛŒÙ† Ø¬Ø¯ÛŒØ¯ Ø§ÛŒÙ† Ù…Ø§Ù‡</h3>
                        <i class="fa-solid fa-user-plus text-teal-500 text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold text-teal-800">{{ new_subscribers_this_month }}</p>
                </div>
            </div>

            <!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ -->
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯</h3>
                    <!-- ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ø§ÛŒÙ† Ù‚Ø³Ù…Øª: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† container Ø¨Ø§ Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª -->
                    <div style="position: relative; height: 250px;">
                        <canvas id="usersChart"></canvas>
                    </div>
                </div>

                <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ -->
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
                    <!-- ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ø§ÛŒÙ† Ù‚Ø³Ù…Øª: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† container Ø¨Ø§ Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª -->
                    <div style="position: relative; height: 250px;">
                        <canvas id="subscriptionsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
    <div x-show="isUserModalOpen" 
         x-cloak
         @keydown.escape.window="closeUserModal()"
         class="fixed inset-0 z-50 overflow-y-auto">
        
        <div class="flex min-h-screen items-center justify-center p-4">
            <div @click="closeUserModal()" 
                 class="fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm"></div>
            
            <div class="relative z-10 w-full max-w-4xl bg-white rounded-xl shadow-2xl my-8 flex flex-col max-h-[90vh]">
                
                <!-- Header -->
                <div class="flex-shrink-0 p-6 flex justify-between items-center border-b border-slate-200 bg-white rounded-t-xl">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center ml-3">
                            <i class="fa-solid fa-users text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800" x-text="userModalTitle"></h3>
                            <p class="text-sm text-slate-500">Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
                        </div>
                    </div>
                    <button @click="closeUserModal()" 
                            class="p-2 text-slate-400 hover:text-slate-700 rounded-full hover:bg-slate-100 transition-colors">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="userModalContent">
                        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ -->
    <div x-show="isSubscriptionModalOpen" 
         x-cloak
         @keydown.escape.window="closeSubscriptionModal()"
         class="fixed inset-0 z-50 overflow-y-auto">
        
        <div class="flex min-h-screen items-center justify-center p-4">
            <div @click="closeSubscriptionModal()" 
                 class="fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm"></div>
            
            <div class="relative z-10 w-full max-w-6xl bg-white rounded-xl shadow-2xl my-8 flex flex-col max-h-[90vh]">
                
                <!-- Header -->
                <div class="flex-shrink-0 p-6 flex justify-between items-center border-b border-slate-200 bg-white rounded-t-xl">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center ml-3">
                            <i class="fa-solid fa-boxes text-indigo-600"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800" x-text="subscriptionModalTitle"></h3>
                            <p class="text-sm text-slate-500">Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§</p>
                        </div>
                    </div>
                    <button @click="closeSubscriptionModal()" 
                            class="p-2 text-slate-400 hover:text-slate-700 rounded-full hover:bg-slate-100 transition-colors">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="subscriptionModalContent">
                        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² jalaali-js -->
<script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.7/dist/jalaali.min.js"></script>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('analysisDashboard', () => ({
        // State variables
        isUserModalOpen: false,
        isSubscriptionModalOpen: false,
        userModalTitle: '',
        subscriptionModalTitle: '',
        activeIncomeChart: 'daily',
        
        // Charts
        incomeChart: null,
        usersChart: null,
        subscriptionsChart: null,

        convertToJalali(gregorianDate) {
            try {
                let year, month, day;
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®
                if (gregorianDate.includes('-')) {
                    // ÙØ±Ù…Øª: YYYY-MM-DD
                    [year, month, day] = gregorianDate.split('-').map(Number);
                } else if (gregorianDate.includes('/')) {
                    // ÙØ±Ù…Øª: MM/DD ÛŒØ§ M/D
                    const parts = gregorianDate.split('/').map(Number);
                    
                    if (parts.length === 2) {
                        // ÙØ±Ù…Øª MM/DD - Ø¨Ø§ÛŒØ¯ Ø³Ø§Ù„ Ø¬Ø§Ø±ÛŒ Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒÙ…
                        const currentYear = new Date().getFullYear();
                        month = parts[0];
                        day = parts[1];
                        year = currentYear;
                    } else if (parts.length === 3) {
                        // ÙØ±Ù…Øª MM/DD/YYYY ÛŒØ§ YYYY/MM/DD
                        if (parts[0] > 1000) {
                            [year, month, day] = parts;
                        } else {
                            [month, day, year] = parts;
                        }
                    }
                } else {
                    console.warn('ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø±:', gregorianDate);
                    return gregorianDate;
                }
                
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² jalaali-js Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„
                const jDate = jalaali.toJalaali(year, month, day);
                
                // ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† - Ø¨Ø¯ÙˆÙ† Ø³Ø§Ù„ (ÙÙ‚Ø· Ù…Ø§Ù‡/Ø±ÙˆØ²)
                const jMonth = String(jDate.jm).padStart(2, '0');
                const jDay = String(jDate.jd).padStart(2, '0');
                
                return `${jMonth}/${jDay}`;
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®:', error, gregorianDate);
                return gregorianDate;
            }
        },
            
        // ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ø¢Ø±Ø§ÛŒÙ‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
        convertLabelsToJalali(labels) {
            return labels.map(label => {
                if (typeof label === 'string') {
                    return this.convertToJalali(label);
                }
                return label;
            });
        },

        init() {
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù„ÙˆØ¯ Ø´Ø¯Ù† Ú©Ø§Ù…Ù„ DOM
            this.$nextTick(() => {
                setTimeout(() => {
                    console.log('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§...');
                    this.loadChartData('income', 'daily');
                    this.loadChartData('users', 'daily');
                    this.loadChartData('subscriptions', 'daily');
                }, 150);
            });
        },

        // User Modal Methods
        async openUserModal(userType) {
            this.isUserModalOpen = true;
            
            const titles = {
                'admin': 'Ù„ÛŒØ³Øª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§',
                'regular': 'Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ', 
                'premium': 'Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙˆÛŒÚ˜Ù‡'
            };
            this.userModalTitle = titles[userType] || 'Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†';
            
            try {
                const response = await fetch(`{% url 'dashboard:analysis:user_stats' %}?type=${userType}`);
                const data = await response.json();
                
                if (response.ok) {
                    this.renderUserModalContent(data);
                } else {
                    this.showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        },

        renderUserModalContent(data) {
            const container = document.getElementById('userModalContent');
            
            if (data.type === 'premium') {
                container.innerHTML = this.renderPremiumUsers(data.users);
            } else {
                container.innerHTML = this.renderRegularUsers(data.users, data.type);
            }
        },

        renderRegularUsers(users, type) {
            const headers = {
                'admin': ['Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ', 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†', 'Ø§ÛŒÙ…ÛŒÙ„', 'ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…'],
                'regular': ['Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ', 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†', 'Ø§ÛŒÙ…ÛŒÙ„', 'Ú©Ø¯ Ù†Ø¸Ø§Ù… Ù¾Ø²Ø´Ú©ÛŒ', 'ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…']
            };
            
            const headerCells = headers[type].map(header => 
                `<th class="px-4 py-3 text-right text-sm font-semibold text-slate-700 bg-slate-50">${header}</th>`
            ).join('');
            
            const rows = users.map(user => `
                <tr class="border-b border-slate-200 hover:bg-slate-50">
                    <td class="px-4 py-3 text-sm text-slate-700">${user.full_name}</td>
                    <td class="px-4 py-3 text-sm text-slate-700 font-mono">${user.phone_number}</td>
                    <td class="px-4 py-3 text-sm text-slate-700">${user.email}</td>
                    ${type === 'regular' ? `<td class="px-4 py-3 text-sm text-slate-700">${user.medical_code}</td>` : ''}
                    <td class="px-4 py-3 text-sm text-slate-700">${user.date_joined}</td>
                </tr>
            `).join('');
            
            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>${headerCells}</tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    ${users.length === 0 ? '<p class="text-center py-8 text-slate-500">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>' : ''}
                </div>
            `;
        },

        renderPremiumUsers(users) {
            const rows = users.map(user => `
                <div class="border border-slate-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-slate-800">${user.full_name}</h4>
                            <p class="text-sm text-slate-600">${user.phone_number} â€¢ ${user.email}</p>
                        </div>
                    </div>
                    
                    ${user.active_subscription ? `
                        <div class="bg-blue-50 rounded-lg p-3 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-blue-800">Ù¾Ù„Ù† ÙØ¹Ø§Ù„</span>
                                <button onclick="this.parentElement.parentElement.querySelector('.plan-details').classList.toggle('hidden')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fa-solid fa-chevron-down ml-1"></i>
                                    Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ù„Ù†
                                </button>
                            </div>
                            <p class="text-sm text-blue-700">${user.active_subscription.plan_name} - ${user.active_subscription.membership}</p>
                            
                            <div class="plan-details hidden mt-3 pt-3 border-t border-blue-200">
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-slate-600">Ù‚ÛŒÙ…Øª:</span>
                                        <span class="font-mono font-semibold">${user.active_subscription.price} Ø±ÛŒØ§Ù„</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-600">Ø´Ø±ÙˆØ¹:</span>
                                        <span>${user.active_subscription.start_date}</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-600">Ø§Ù†Ù‚Ø¶Ø§:</span>
                                        <span>${user.active_subscription.end_date}</span>
                                    </div>
                                    <div>
                                        <span class="text-slate-600">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡:</span>
                                        <span class="font-semibold ${user.active_subscription.days_remaining < 7 ? 'text-red-600' : 'text-green-600'}">
                                            ${user.active_subscription.days_remaining} Ø±ÙˆØ²
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : '<p class="text-orange-600 text-sm">Ù‡ÛŒÚ† Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±Ø¯</p>'}
                </div>
            `).join('');
            
            return `
                <div class="space-y-4">
                    ${rows}
                    ${users.length === 0 ? '<p class="text-center py-8 text-slate-500">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒÚ˜Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>' : ''}
                </div>
            `;
        },

        closeUserModal() {
            this.isUserModalOpen = false;
        },

        // Subscription Modal Methods
        async openSubscriptionModal(type) {
            this.isSubscriptionModalOpen = true;
            
            const titles = {
                'subscribers': 'Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø´ØªØ±Ú©ÛŒÙ†',
                'plans': 'Ø¬Ø²Ø¦ÛŒØ§Øª ÙØ±ÙˆØ´ Ù¾Ù„Ù†â€ŒÙ‡Ø§'
            };
            this.subscriptionModalTitle = titles[type] || 'Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§';
            
            try {
                const response = await fetch(`{% url 'dashboard:analysis:subscription_stats' %}?type=${type}`);
                const data = await response.json();
                
                if (response.ok) {
                    this.renderSubscriptionModalContent(data, type);
                } else {
                    this.showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        },

        renderSubscriptionModalContent(data, type) {
            const container = document.getElementById('subscriptionModalContent');
            
            if (type === 'subscribers') {
                container.innerHTML = this.renderSubscribersDetail(data);
            } else {
                container.innerHTML = this.renderPlansSalesDetail(data);
            }
        },

        renderSubscribersDetail(data) {
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 rounded-lg p-6 text-center">
                            <i class="fa-solid fa-users text-blue-500 text-3xl mb-3"></i>
                            <h4 class="text-lg font-semibold text-blue-700 mb-2">Ù…Ø´ØªØ±Ú©ÛŒÙ† Ø§ÛŒÙ† Ù…Ø§Ù‡</h4>
                            <p class="text-3xl font-bold text-blue-800">${data.subscribers_this_month}</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6 text-center">
                            <i class="fa-solid fa-user-friends text-green-500 text-3xl mb-3"></i>
                            <h4 class="text-lg font-semibold text-green-700 mb-2">Ú©Ù„ Ù…Ø´ØªØ±Ú©ÛŒÙ†</h4>
                            <p class="text-3xl font-bold text-green-800">${data.total_subscribers}</p>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-slate-700 mb-4">Ø±ÙˆÙ†Ø¯ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ù…Ø´ØªØ±Ú©ÛŒÙ† Ø¬Ø¯ÛŒØ¯</h4>
                        <div class="space-y-3">
                            ${data.monthly_trend.map(item => `
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-600">${item.month}</span>
                                    <span class="font-semibold text-slate-800">${item.subscribers} Ù…Ø´ØªØ±Ú©</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        },

        renderPlansSalesDetail(data) {
            return `
                <div class="space-y-6">
                    ${data.membership_stats.map(membership => `
                        <div class="border border-slate-200 rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-semibold text-slate-700">${membership.membership_title}</h4>
                                <div class="text-right">
                                    <p class="text-sm text-slate-600">ÙØ±ÙˆØ´ Ú©Ù„: <span class="font-semibold">${membership.total_plans_sold}</span></p>
                                    <p class="text-sm text-slate-600">Ø¯Ø±Ø¢Ù…Ø¯: <span class="font-semibold">${membership.total_revenue} Ø±ÛŒØ§Ù„</span></p>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">Ù†Ø§Ù… Ù¾Ù„Ù†</th>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">Ù…Ø¯Øª (Ø±ÙˆØ²)</th>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">Ù‚ÛŒÙ…Øª (Ø±ÛŒØ§Ù„)</th>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´</th>
                                            <th class="px-4 py-2 text-right text-sm font-semibold text-slate-700 bg-slate-50">Ø¯Ø±Ø¢Ù…Ø¯</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${membership.plans.map(plan => `
                                            <tr class="border-b border-slate-200 hover:bg-slate-50">
                                                <td class="px-4 py-3 text-sm text-slate-700">${plan.name}</td>
                                                <td class="px-4 py-3 text-sm text-slate-700">${plan.duration_days}</td>
                                                <td class="px-4 py-3 text-sm text-slate-700 font-mono">${plan.price}</td>
                                                <td class="px-4 py-3 text-sm text-slate-700">${plan.sales_count}</td>
                                                <td class="px-4 py-3 text-sm text-slate-700 font-mono">${plan.revenue} Ø±ÛŒØ§Ù„</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        },

        closeSubscriptionModal() {
            this.isSubscriptionModalOpen = false;
        },

        // Chart Methods
        async loadChartData(chartType, period) {
            try {
                const response = await fetch(`{% url 'dashboard:analysis:chart_data' %}?type=${chartType}`);
                const data = await response.json();
                
                if (response.ok) {
                    this.renderChart(chartType, data);
                    if (chartType === 'income') {
                        this.activeIncomeChart = period;
                    }
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        },

        renderChart(chartType, data) {
            const canvas = document.getElementById(`${chartType}Chart`);
            if (!canvas) {
                console.error(`Canvas element not found: ${chartType}Chart`);
                return;
            }
        
            const ctx = canvas.getContext('2d');
            
            // Ø§Ø² Ø¨ÛŒÙ† Ø¨Ø±Ø¯Ù† chart Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
            if (chartType === 'income' && this.incomeChart) {
                this.incomeChart.destroy();
            } else if (chartType === 'users' && this.usersChart) {
                this.usersChart.destroy();
            } else if (chartType === 'subscriptions' && this.subscriptionsChart) {
                this.subscriptionsChart.destroy();
            }
            
            // ğŸ”¥ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú†Ø§Ø±Øª
            const jalaliLabels = this.convertLabelsToJalali(data.labels);
            
            console.log('ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ù…ÛŒÙ„Ø§Ø¯ÛŒ):', data.labels);
            console.log('ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù‡ (Ø´Ù…Ø³ÛŒ):', jalaliLabels);
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: jalaliLabels, // ğŸ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø³ÛŒ
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            rtl: true,
                            labels: {
                                font: {
                                    family: 'Vazirmatn, sans-serif',
                                    size: 12
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            rtl: true,
                            textDirection: 'rtl',
                            titleFont: {
                                family: 'Vazirmatn, sans-serif',
                                size: 13
                            },
                            bodyFont: {
                                family: 'Vazirmatn, sans-serif',
                                size: 12
                            },
                            // ğŸ¯ Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¯Ø± tooltip
                            callbacks: {
                                title: (tooltipItems) => {
                                    return tooltipItems[0].label; // ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    family: 'Vazirmatn, sans-serif',
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: 'Vazirmatn, sans-serif',
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
            
            // Ø°Ø®ÛŒØ±Ù‡ reference Ø¨Ù‡ chart
            if (chartType === 'income') {
                this.incomeChart = chart;
            } else if (chartType === 'users') {
                this.usersChart = chart;
            } else if (chartType === 'subscriptions') {
                this.subscriptionsChart = chart;
            }
        },


        // Utility Methods
        refreshData() {
            window.location.reload();
        },

        showError(message) {
            alert(message);
        }
    }));
});
</script>

<style>
.chart-container {
    position: relative;
    height: 300px;
}

canvas {
    display: block;
    max-width: 100%;
}

.container {
    overflow-x: hidden;
}
</style>
{% endblock %}
