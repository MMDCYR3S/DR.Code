{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}سوالات کاربران{% endblock %}

{% block extra_css %}
<style>
    .tr-link { 
        cursor: pointer; 
    }
    .question-unread {
        background-color: rgba(59, 130, 246, 0.05);
    }
    .question-unread:hover {
        background-color: rgba(59, 130, 246, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto">
    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-slate-700">
                سوالات دریافتی از نسخه‌ها
            </h1>
            <p class="text-slate-500 mt-1">
                مجموع {{ stats.total_questions }} سوال از کاربران ویژه
            </p>
        </div>
        
        <!-- Quick Stats -->
        <div class="flex items-center space-x-4 space-x-reverse mt-4 sm:mt-0">
            <div class="bg-white px-4 py-2 rounded-lg shadow-sm border">
                <div class="text-xs text-slate-500">امروز</div>
                <div class="text-lg font-bold text-blue-600">{{ stats.today_questions }}</div>
            </div>
            <div class="bg-white px-4 py-2 rounded-lg shadow-sm border">
                <div class="text-xs text-slate-500">پاسخ نداده</div>
                <div class="text-lg font-bold text-red-600">{{ stats.unread_questions }}</div>
            </div>
        </div>
    </div>

    <!-- Filter and Search Section -->
    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 border">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            
            <!-- Filter Tabs -->
            <div class="flex items-center space-x-1 space-x-reverse bg-slate-100 p-1 rounded-lg">
                <a href="?status=unread{% if current_search %}&search={{ current_search }}{% endif %}" 
                   class="px-4 py-2 text-sm font-semibold rounded-md transition-all duration-200 
                          {% if current_status == 'unread' %}bg-white shadow-sm text-blue-600 border{% else %}text-slate-600 hover:text-slate-800{% endif %}">
                    <i class="fa-solid fa-exclamation-circle ml-1"></i>
                    خوانده نشده ({{ stats.unread_questions }})
                </a>
                <a href="?status=read{% if current_search %}&search={{ current_search }}{% endif %}" 
                   class="px-4 py-2 text-sm font-semibold rounded-md transition-all duration-200 
                          {% if current_status == 'read' %}bg-white shadow-sm text-blue-600 border{% else %}text-slate-600 hover:text-slate-800{% endif %}">
                    <i class="fa-solid fa-check-circle ml-1"></i>
                    خوانده شده ({{ stats.read_questions }})
                </a>
                <a href="?status=all{% if current_search %}&search={{ current_search }}{% endif %}" 
                   class="px-4 py-2 text-sm font-semibold rounded-md transition-all duration-200 
                          {% if current_status == 'all' %}bg-white shadow-sm text-blue-600 border{% else %}text-slate-600 hover:text-slate-800{% endif %}">
                    <i class="fa-solid fa-list ml-1"></i>
                    همه سوالات ({{ stats.total_questions }})
                </a>
            </div>
            
            <!-- Search Box -->
            <div class="flex items-center">
                <form method="GET" class="flex">
                    <input type="hidden" name="status" value="{{ current_status }}">
                    <div class="relative">
                        <input type="text" 
                               name="search" 
                               value="{{ current_search }}" 
                               placeholder="جستجو در سوالات، نام کاربر یا عنوان نسخه..." 
                               class="w-full sm:w-80 px-4 py-2 pr-10 border border-slate-300 rounded-r-lg text-sm 
                                      focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <i class="fa-solid fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    </div>
                    <button type="submit" 
                            class="px-6 py-1 bg-blue-500 text-white rounded-l-lg hover:bg-blue-600 
                                   transition-colors duration-200 border border-blue-500">
                        <i class="fa-solid fa-search"></i>
                    </button>
                    {% if current_search %}
                    <a href="?status={{ current_status }}" 
                       class="mr-2 px-3 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600 transition-colors">
                        <i class="fa-solid fa-times"></i>
                    </a>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <!-- Desktop Table -->
    <div class="hidden lg:block bg-white rounded-xl shadow-sm overflow-hidden border">
        <table class="min-w-full text-sm">
            <thead class="bg-slate-50 text-slate-600 border-b">
                <tr>
                    <th scope="col" class="p-4 text-right">
                        <input type="checkbox" class="rounded border-slate-300 text-blue-500 focus:ring-blue-500">
                    </th>
                    <th scope="col" class="px-6 py-4 text-right font-semibold">
                        <i class="fa-solid fa-user ml-2"></i>فرستنده
                    </th>
                    <th scope="col" class="px-6 py-4 text-right font-semibold">
                        <i class="fa-solid fa-file-prescription ml-2"></i>نسخه و سوال
                    </th>
                    <th scope="col" class="px-6 py-4 text-right font-semibold">
                        <i class="fa-solid fa-clock ml-2"></i>تاریخ
                    </th>
                    <th scope="col" class="px-6 py-4 text-right font-semibold">
                        <i class="fa-solid fa-cog ml-2"></i>عملیات
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
                {% for question in questions %}
                <tr class="tr-link hover:bg-slate-50 transition-colors duration-200 
                          {% if not question.is_answered %}question-unread{% endif %}"
                    onclick="handleRowClick(event, '{% url 'dashboard:questions:questions_detail' question.id %}')">
                    <td class="p-4">
                        <input type="checkbox" 
                               class="rounded border-slate-300 text-blue-500 focus:ring-blue-500"
                               onclick="event.stopPropagation();">
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center">
                                    <i class="fa-solid fa-user text-slate-500"></i>
                                </div>
                            </div>
                            <div class="mr-4">
                                <div class="{% if not question.is_answered %}font-bold text-slate-900{% else %}font-semibold text-slate-700{% endif %}">
                                    {{ question.user.full_name }}
                                </div>
                                <div class="text-xs text-slate-500">
                                    {{ question.user.email|default:question.user.phone_number }}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="{% if not question.is_answered %}font-bold text-slate-900{% else %}font-semibold text-slate-700{% endif %}">
                            <i class="fa-solid fa-file-prescription text-blue-500 ml-2"></i>
                            {{ question.prescription.title }}
                        </div>
                        <div class="text-sm text-slate-500 mt-1">
                            {{ question.question_text|truncatechars:100 }}
                        </div>
                        {% if question.is_recent %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mt-2">
                            <i class="fa-solid fa-star ml-1"></i>جدید
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-slate-600">
                            <i class="fa-solid fa-calendar-alt ml-2"></i>
                            {{ question.jalali_date }}
                        </div>
                        <div class="text-xs text-slate-500">
                            {{ question.jalali_time }}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if question.is_answered %}
                            <a href="{% url 'dashboard:questions:questions_detail' question.id %}" 
                               class="inline-flex items-center px-3 py-2 border border-green-300 rounded-md text-sm 
                                      font-medium text-green-700 bg-green-50 hover:bg-green-100 transition-colors duration-200"
                               onclick="event.stopPropagation();">
                                <i class="fa-solid fa-eye ml-2"></i>
                                مشاهده پاسخ
                            </a>
                        {% else %}
                            <a href="{% url 'dashboard:questions:questions_detail' question.id %}" 
                               class="inline-flex items-center px-3 py-2 border border-blue-300 rounded-md text-sm 
                                      font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors duration-200"
                               onclick="event.stopPropagation();">
                                <i class="fa-solid fa-reply ml-2"></i>
                                پاسخ دادن
                            </a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fa-solid fa-comments text-4xl text-slate-300 mb-3"></i>
                            <p class="text-slate-500 text-lg">هیچ سوالی یافت نشد</p>
                            <p class="text-slate-400 text-sm mt-1">
                                {% if current_search %}
                                برای عبارت "{{ current_search }}" نتیجه‌ای پیدا نشد
                                {% else %}
                                هنوز هیچ سوالی ثبت نشده است
                                {% endif %}
                            </p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Cards -->
    <div class="grid grid-cols-1 gap-4 lg:hidden">
        {% for question in questions %}
        <div class="bg-white rounded-xl shadow-sm border {% if not question.is_answered %}border-r-4 border-r-blue-500{% endif %}">
            <a href="{% url 'dashboard:questions:questions_detail' question.id %}" class="block p-4">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center">
                        <div class="h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-user text-slate-500 text-sm"></i>
                        </div>
                        <div class="mr-3">
                            <p class="{% if not question.is_answered %}font-bold text-slate-900{% else %}font-semibold text-slate-700{% endif %} text-sm">
                                {{ question.user.full_name }}
                            </p>
                            <p class="text-xs text-slate-500">
                                {{ question.user.email|default:question.user.phone_number }}
                            </p>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 text-left">
                        <div>{{ question.jalali_date }}</div>
                        <div>{{ question.jalali_time }}</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-file-prescription text-blue-500 ml-2"></i>
                        <span class="{% if not question.is_answered %}font-bold{% else %}font-semibold{% endif %} text-sm">
                            {{ question.prescription.title }}
                        </span>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed">
                        {{ question.question_text|truncatechars:120 }}
                    </p>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 space-x-reverse">
                        {% if question.is_answered %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fa-solid fa-check ml-1"></i>پاسخ داده شده
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <i class="fa-solid fa-clock ml-1"></i>در انتظار پاسخ
                            </span>
                        {% endif %}
                        
                        {% if question.is_recent %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fa-solid fa-star ml-1"></i>جدید
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="text-xs text-blue-600 font-medium">
                        {% if question.is_answered %}
                            مشاهده پاسخ
                        {% else %}
                            پاسخ دادن
                        {% endif %}
                        <i class="fa-solid fa-chevron-left mr-1"></i>
                    </div>
                </div>
            </a>
        </div>
        {% empty %}
        <div class="text-center py-12 bg-white rounded-xl border">
            <i class="fa-solid fa-comments text-4xl text-slate-300 mb-3"></i>
            <p class="text-slate-500 text-lg">هیچ سوالی یافت نشد</p>
            <p class="text-slate-400 text-sm mt-1">
                {% if current_search %}
                برای عبارت "{{ current_search }}" نتیجه‌ای پیدا نشد
                {% else %}
                هنوز هیچ سوالی ثبت نشده است
                {% endif %}
            </p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="mt-8 flex justify-center">
        <nav class="flex items-center space-x-2 space-x-reverse">
            {% if page_obj.has_previous %}
                <a href="?page=1{% if current_status != 'unread' %}&status={{ current_status }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}" 
                   class="px-3 py-2 text-sm font-medium text-slate-500 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors">
                    <i class="fa-solid fa-angle-double-right"></i>
                </a>
                <a href="?page={{ page_obj.previous_page_number }}{% if current_status != 'unread' %}&status={{ current_status }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}" 
                   class="px-3 py-2 text-sm font-medium text-slate-500 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors">
                    <i class="fa-solid fa-angle-right ml-1"></i>قبلی
                </a>
            {% endif %}
            
            <span class="px-4 py-2 text-sm text-slate-700 bg-white border border-slate-300 rounded-md">
                صفحه {{ page_obj.number }} از {{ page_obj.paginator.num_pages }}
            </span>
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if current_status != 'unread' %}&status={{ current_status }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}" 
                   class="px-3 py-2 text-sm font-medium text-slate-500 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors">
                    بعدی<i class="fa-solid fa-angle-left mr-1"></i>
                </a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% if current_status != 'unread' %}&status={{ current_status }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}" 
                   class="px-3 py-2 text-sm font-medium text-slate-500 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors">
                    <i class="fa-solid fa-angle-double-left"></i>
                </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    function handleRowClick(event, url) {
        // جلوگیری از کلیک روی چک باکس و دکمه‌ها
        if (event.target.type === 'checkbox' || 
            event.target.tagName === 'A' || 
            event.target.tagName === 'BUTTON' ||
            event.target.closest('a') ||
            event.target.closest('button')) {
            return;
        }
        window.location.href = url;
    }

    // اضافه کردن قابلیت انتخاب همه چک باکس‌ها
    document.addEventListener('DOMContentLoaded', function() {
        const masterCheckbox = document.querySelector('thead input[type="checkbox"]');
        const rowCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');
        
        if (masterCheckbox) {
            masterCheckbox.addEventListener('change', function() {
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        }

        // اضافه کردن اعلان موفقیت برای عملیات
        {% if messages %}
        {% for message in messages %}
            window.dispatchEvent(new CustomEvent('notify', {
                detail: {
                    type: '{{ message.tags }}',
                    message: '{{ message|escapejs }}'
                }
            }));
        {% endfor %}
        {% endif %}
    });
</script>
{% endblock %}
