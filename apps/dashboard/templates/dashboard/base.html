<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - دکتر کد</title>
    
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        [x-cloak] { display: none !important; }
        
        .sidebar-icon {
            width: 1.5rem; /* 24px */
            text-align: center;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-slate-100 text-slate-800">

    <div x-data="notificationManager" 
         @notify.window="add($event.detail)"
         class="fixed top-5 left-5 z-[100] w-full max-w-xs space-y-3">
        <template x-for="notification in notifications" :key="notification.id">
            <div x-show="notification.visible" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="transform -translate-x-full opacity-0"
                 x-transition:enter-end="transform translate-x-0 opacity-100"
                 x-transition:leave="transition ease-in duration-300"
                 x-transition:leave-start="transform opacity-100"
                 x-transition:leave-end="transform -translate-x-full opacity-0"
                 class="relative w-full rounded-lg shadow-lg pointer-events-auto"
                 :class="{ 'bg-green-500': notification.type === 'success', 'bg-red-500': notification.type === 'error' }">
                <div class="p-4 flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fa-solid text-white" :class="{ 'fa-check-circle': notification.type === 'success', 'fa-times-circle': notification.type === 'error' }"></i>
                    </div>
                    <div class="mr-3 flex-1">
                        <p class="text-sm font-semibold text-white" x-text="notification.message"></p>
                    </div>
                    <div class="flex-shrink-0 flex">
                        <button @click="remove(notification.id)" class="inline-flex text-white opacity-70 hover:opacity-100">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <div x-data="{ sidebarOpen: false }" class="flex h-screen bg-slate-100">
        <aside
            :class="sidebarOpen ? 'translate-x-0' : 'translate-x-full'"
            class="fixed inset-y-0 right-0 z-30 w-64 bg-slate-800 text-white shadow-lg transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 flex flex-col">
            
            <div class="flex-shrink-0 flex items-center justify-center px-6 py-4 border-b border-slate-700">
                <svg class="h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 18.75V16.5M16.5 3.75V16.5M12 12.75H5.25A2.25 2.25 0 013 10.5V8.25A2.25 2.25 0 015.25 6H12M12 12.75V18M12 12.75A3 3 0 0115 9.75V4.5A3 3 0 0112 1.5h-1.5a3 3 0 00-3 3v1.5" />
                </svg>
                <span class="ml-4 mr-2 text-xl font-bold">دکتر کد</span>
            </div>

            <nav class="flex-1 overflow-y-auto py-6">
                <a href="" class="flex items-center px-6 py-2 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200 {% if request.resolver_match.url_name == 'dashboard' %}bg-slate-700 text-blue-300{% endif %}">
                    <i class="fa-solid fa-house sidebar-icon"></i>
                    <span class="mx-3">داشبورد</span>
                </a>
                <a href="{% url 'dashboard:users:users_list' %}" class="flex items-center px-6 py-2 mt-2 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200 {% if request.resolver_match.url_name == 'users_list' %}bg-slate-700 text-blue-300{% endif %}">
                    <i class="fa-solid fa-users sidebar-icon"></i>
                    <span class="mx-3">مدیریت کاربران</span>
                </a>
                <a href="{% url 'dashboard:users:admin_verification_queue' %}" class="flex items-center px-6 py-2 mt-2 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200 {% if request.resolver_match.url_name == 'admin_verification_queue' %}bg-slate-700 text-blue-300{% endif %}">
                    <i class="fa-solid fa-user-check sidebar-icon"></i>
                    <span class="mx-3">احراز هویت</span>
                </a>
                <a href="{% url 'dashboard:prescriptions:prescription_list' %}" class="flex items-center px-6 py-2 mt-2 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200 {% if request.resolver_match.url_name == 'prescription_list' %}bg-slate-700 text-blue-300{% endif %}">
                    <i class="fa-solid fa-file-prescription sidebar-icon"></i>
                    <span class="mx-3">مدیریت نسخه‌ها</span>
                </a>
                <a href="{% url 'dashboard:categories:category_list' %}" class="flex items-center px-6 py-2 mt-2 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors duration-200 {% if request.resolver_match.url_name == 'category_list' %}bg-slate-700 text-blue-300{% endif %}">
                    <i class="fa-solid fa-sitemap sidebar-icon"></i>
                    <span class="mx-3">دسته‌بندی‌ها</span>
                </a>
                <a href="#" class="flex items-center px-6 py-2 mt-2 text-slate-300 hover:bg-slate-700 hover:text-white">
                    <i class="fa-solid fa-comments sidebar-icon"></i>
                    <span class="mx-3">سوالات کاربران</span>
                </a>
                <a href="{% url 'dashboard:contacts:contacts_list' %}" class="flex items-center px-6 py-2 mt-2 text-slate-300 hover:bg-slate-700 hover:text-white
                 {% if request.resolver_match.url_name == 'contacts_list' %}bg-slate-700 text-blue-300{% endif %}">
                    <i class="fa-solid fa-envelope sidebar-icon"></i>
                    <span class="mx-3">پیام‌های تماس</span>
                </a>
                <a href="#" class="flex items-center px-6 py-2 mt-2 text-slate-300 hover:bg-slate-700 hover:text-white">
                    <i class="fa-solid fa-tags sidebar-icon"></i>
                    <span class="mx-3">کدهای تخفیف</span>
                </a>
                
                <button type="button" onclick="logoutUser()" 
                    class="flex items-center px-6 py-2 mt-2 text-slate-300 
                        hover:bg-slate-700 hover:text-white 
                        w-full text-left transition-colors duration-200">
                    <i class="fa-solid fa-sign-out sidebar-icon"></i>
                    <span class="mx-3">خروج</span>
                </button>

            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 bg-white border-b lg:hidden">
                <div class="flex items-center">
                    <svg class="h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 18.75V16.5M16.5 3.75V16.5M12 12.75H5.25A2.25 2.25 0 013 10.5V8.25A2.25 2.25 0 015.25 6H12M12 12.75V18M12 12.75A3 3 0 0115 9.75V4.5A3 3 0 0112 1.5h-1.5a3 3 0 00-3 3v1.5" />
                    </svg>
                    <span class="ml-4 mr-2 text-lg font-bold">دکتر کد</span>
                </div>
                <button @click="sidebarOpen = !sidebarOpen" class="text-slate-500 focus:outline-none">
                    <i class="fa-solid fa-bars h-6 w-6"></i>
                </button>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-4 sm:p-6">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('notificationManager', () => ({
                notifications: [],
                counter: 0,
                add(notification) {
                    notification.id = this.counter++;
                    notification.visible = true;
                    this.notifications.push(notification);
                    setTimeout(() => {
                        this.remove(notification.id);
                    }, 5000);
                },
                remove(id) {
                    const notification = this.notifications.find(n => n.id === id);
                    if (notification) {
                        notification.visible = false;
                        setTimeout(() => {
                           const index = this.notifications.findIndex(n => n.id === id);
                           if(index > -1) this.notifications.splice(index, 1);
                        }, 300);
                    }
                }
            }));
        });
    </script>

    <script>
        function getCookie(name) {
            // این تابع برای گرفتن توکن CSRF لازم است
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function logoutUser() {
            // مرحله حیاتی: خواندن توکن‌ها از حافظه localStorage مرورگر
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');

            if (!accessToken) {
                alert('شما وارد سیستم نشده‌اید.');
                // اگر توکنی وجود نداشت، مستقیم به صفحه لاگین برو
                window.location.href = "{% url 'api:v1:accounts:login' %}"; // <-- این آدرس را تغییر دهید
                return;
            }

            fetch("{% url 'api:v1:accounts:logout' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    // مهم‌ترین بخش: ارسال توکن دسترسی برای احراز هویت
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    'refresh_token': refreshToken // ارسال رفرش توکن برای باطل کردن آن
                })
            })
            .then(response => {
                // در هر صورت (موفق یا ناموفق) توکن‌ها را از حافظه مرورگر پاک می‌کنیم
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                
                if (response.ok) {
                    // در صورت موفقیت، کاربر را به صفحه ورود هدایت می‌کنیم
                    window.location.href = "{% url 'api:v1:accounts:login' %}"; // <-- این آدرس را تغییر دهید
                } else {
                    console.error('خروج از سمت سرور با خطا مواجه شد.');
                    alert('خروج با خطا مواجه شد، اما نشست شما در مرورگر پاک شد.');
                    window.location.href = "{% url 'api:v1:accounts:login' %}"; // <-- این آدرس را تغییر دهید
                }
            })
            .catch(error => {
                console.error('خطا در هنگام ارسال درخواست خروج:', error);
                // حتی در صورت خطای شبکه، توکن‌ها را پاک کرده و کاربر را به صفحه لاگین می‌بریم
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = "{% url 'api:v1:accounts:login' %}"; // <-- این آدرس را تغییر دهید
            });
        }
    </script>

    {% block extra_js %}{% endblock %}
    {% include 'dashboard/messages.html' %}
</body>
</html>