{% extends 'dashboard/base.html' %}
{% load file_filters %}

{% block title %}جزئیات کاربر: {{ target_user.full_name }}{% endblock %}

{% block content %}
<main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-4 sm:p-6" 
      x-data="userDetailComponent({{ target_user.id }}, '{{ target_user.full_name|escapejs }}')">
    <div class="container mx-auto">
        <div class="flex items-center space-x-2 space-x-reverse mb-6">
            <h1 class="text-2xl font-bold text-slate-700">{{ target_user.full_name }}</h1>
            
            {% if profile.auth_status == 'PENDING' %}
                <span class="px-3 py-1 text-xs font-semibold text-orange-800 bg-orange-200 rounded-full">در انتظار تایید</span>
            {% elif profile.auth_status == 'APPROVED' %}
                <span class="px-3 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">تایید شده</span>
            {% elif profile.auth_status == 'REJECTED' %}
                <span class="px-3 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">رد شده</span>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">مدارک ارسالی</h3>
                    <div class="space-y-4">
                        {% if documents %}
                            <div class="grid grid-cols-2 gap-3">
                                {% for doc in documents %}
                                    {% if doc.file.url|file_filter == 'pdf' %}
                                        <a href="{{ doc.file.url }}" target="_blank" download class="col-span-2 flex items-center justify-center text-center p-4 bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold rounded-lg transition-colors border border-blue-200">
                                            <i class="fa-solid fa-file-pdf text-xl ml-3"></i>
                                            <span>دانلود فایل PDF</span>
                                        </a>
                                    {% else %}
                                        <button @click="imageUrl = '{{ doc.file.url }}'; imageViewerOpen = true" class="focus:outline-none">
                                            <img src="{{ doc.file.url }}" alt="مدرک" class="rounded-lg w-full h-auto object-cover border-2 border-slate-200 hover:border-blue-400 transition">
                                        </button>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-sm text-slate-500">هیچ مدرکی بارگذاری نشده است.</p>
                        {% endif %}
                        {% if profile.auth_link %}
                        <div>
                            <a href="{{ profile.auth_link }}" target="_blank" class="inline-flex items-center text-sm text-blue-600 hover:underline">
                                <span>لینک صفحه نظام پزشکی</span>
                                <i class="fa-solid fa-arrow-up-right-from-square mr-1.5 h-4 w-4"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                {% if profile.auth_status == 'PENDING' %}
                <div x-transition class="bg-white p-6 rounded-xl shadow-sm border-2 border-dashed border-orange-300">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">بررسی و تایید هویت کاربر</h3>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button type="button" @click="approveModalOpen = true" class="w-full py-3 px-5 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition">تایید هویت</button>
                        <button type="button" @click="rejectModalOpen = true" class="w-full py-3 px-5 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition">رد هویت</button>
                    </div>
                </div>
                {% endif %}

                <!-- بخش مدیریت اشتراک -->
                <div class="bg-white p-6 rounded-xl shadow-sm border-2" :class="hasActiveSubscription ? 'border-green-300' : 'border-slate-200'">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-700">مدیریت اشتراک</h3>
                        <span x-show="hasActiveSubscription" class="px-3 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">
                            اشتراک فعال
                        </span>
                    </div>
                    
                    <!-- اطلاعات اشتراک فعال -->
                    <div x-show="hasActiveSubscription && activeSubscription" class="space-y-3 mb-4">
                        <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border border-green-200">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                                <div class="flex flex-col">
                                    <span class="text-slate-500 text-xs">نام پلن:</span>
                                    <span class="font-semibold mt-1" x-text="activeSubscription?.plan_name"></span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-slate-500 text-xs">تاریخ انقضا:</span>
                                    <span class="font-semibold mt-1" x-text="activeSubscription?.end_date"></span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-slate-500 text-xs">روزهای باقیمانده:</span>
                                    <span class="font-semibold mt-1" :class="activeSubscription?.days_remaining < 7 ? 'text-red-600' : 'text-green-600'" x-text="activeSubscription?.days_remaining + ' روز'"></span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-slate-500 text-xs">وضعیت:</span>
                                    <span class="font-semibold mt-1 text-green-600" x-text="activeSubscription?.status_display"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- دکمه‌های عملیات -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button 
                            x-show="!hasActiveSubscription" 
                            @click="openCreateSubscriptionModal()" 
                            class="flex-1 py-3 px-5 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-plus ml-2"></i>
                            افزودن اشتراک
                        </button>
                        
                        <button 
                            x-show="hasActiveSubscription" 
                            @click="openEditSubscriptionModal()" 
                            class="flex-1 py-3 px-5 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-pen-to-square ml-2"></i>
                            ویرایش اشتراک
                        </button>
                        
                        <button 
                            x-show="hasActiveSubscription" 
                            @click="openExtendSubscriptionModal()" 
                            class="flex-1 py-3 px-5 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-clock-rotate-left ml-2"></i>
                            تمدید اشتراک
                        </button>
                    </div>

                    <!-- لیست تمام اشتراک‌های کاربر -->
                    <div x-show="allSubscriptions.length > 0" class="mt-6 border-t pt-4">
                        <h4 class="text-sm font-semibold text-slate-600 mb-3">تاریخچه اشتراک‌ها</h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            <template x-for="sub in allSubscriptions" :key="sub.id">
                                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 text-xs">
                                    <div class="flex justify-between items-start">
                                        <div class="space-y-1">
                                            <div class="font-semibold" x-text="sub.plan_name"></div>
                                            <div class="text-slate-500">
                                                <span x-text="sub.start_date"></span>
                                                <span class="mx-1">تا</span>
                                                <span x-text="sub.end_date"></span>
                                            </div>
                                        </div>
                                        <span 
                                            class="px-2 py-1 text-xs font-semibold rounded-full"
                                            :class="{
                                                'bg-green-200 text-green-800': sub.status === 'active',
                                                'bg-red-200 text-red-800': sub.status === 'expired',
                                                'bg-gray-200 text-gray-800': sub.status === 'canceled'
                                            }"
                                            x-text="sub.status_display">
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">مشخصات کاربری</h3>
                    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div class="flex flex-col"><dt class="text-slate-500">نام و نام خانوادگی:</dt><dd class="font-medium mt-1">{{ target_user.full_name }}</dd></div>
                        <div class="flex flex-col"><dt class="text-slate-500">شماره تماس:</dt><dd class="font-medium mt-1">{{ target_user.phone_number }}</dd></div>
                        <div class="flex flex-col"><dt class="text-slate-500">ایمیل:</dt><dd class="font-medium mt-1">{{ target_user.email|default:"ثبت نشده" }}</dd></div>
                        <div class="flex flex-col"><dt class="text-slate-500">تاریخ ثبت نام:</dt><dd class="font-medium mt-1">{{ target_user.shamsi_date_joined }}</dd></div>
                        <div class="flex flex-col sm:col-span-2"><dt class="text-slate-500">کد نظام پزشکی / دانشجویی:</dt>
                            <dd class="font-medium mt-1 p-2 bg-slate-50 rounded-md">
                                {% if profile.medical_code %}{{ profile.medical_code }}{% else %}<span class="text-slate-400 italic">وارد نشده</span>{% endif %}
                            </dd>
                        </div>
                    </dl>
                    <div class="border-t mt-6 pt-4 flex flex-wrap gap-3">
                        <button @click="openEditModal()" class="flex-1 min-w-[150px] py-2 px-4 text-sm font-semibold bg-blue-200 text-blue-700 rounded-lg hover:bg-blue-300 transition">ویرایش مشخصات</button>
                        <button @click="openDeleteModal()" class="flex-1 min-w-[150px] py-2 px-4 text-sm font-semibold bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">حذف کاربر</button>
                        <button onclick="window.location.href='{% url 'dashboard:users:admin_users_list' %}'" class="flex-1 min-w-[150px] py-2 px-4 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">بازگشت</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال افزودن اشتراک -->
    <div x-show="createSubscriptionModalOpen" x-cloak @keydown.escape.window="createSubscriptionModalOpen = false" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="createSubscriptionModalOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div x-show="createSubscriptionModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-lg">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-800">افزودن اشتراک جدید</h3>
                    <button @click="createSubscriptionModalOpen = false" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                
                <form @submit.prevent="createSubscription()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            انتخاب پلن اشتراک
                            <span class="text-red-500">*</span>
                        </label>
                        <select 
                            x-model="subscriptionForm.plan_id" 
                            @change="updatePlanPrice()"
                            required
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">لطفاً یک پلن انتخاب کنید</option>
                            <template x-for="plan in availablePlans" :key="plan.id">
                                <option :value="plan.id">
                                    <span x-text="plan.name"></span> - 
                                    <span x-text="plan.membership"></span> 
                                    (<span x-text="plan.duration_months"></span> ماه)
                                </option>
                            </template>
                        </select>
                    </div>

                    <div x-show="subscriptionForm.plan_id">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            مبلغ (تومان)
                        </label>
                        <div class="relative">
                            <input 
                                type="text" 
                                x-model="subscriptionForm.payment_amount"
                                readonly
                                class="w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-lg text-slate-600 cursor-not-allowed">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
                                <i class="fa-solid fa-coins"></i>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">
                            مبلغ به صورت خودکار از پلن انتخابی تنظیم می‌شود
                        </p>
                    </div>

                    <div x-show="subscriptionForm.plan_id" class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-semibold text-blue-800 mb-2">اطلاعات پلن انتخابی:</h4>
                        <div class="text-xs text-slate-600 space-y-1">
                            <div>مدت زمان: <span class="font-semibold" x-text="selectedPlanInfo?.duration_days + ' روز'"></span></div>
                            <div>نوع عضویت: <span class="font-semibold" x-text="selectedPlanInfo?.membership"></span></div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-2 space-x-reverse pt-4 border-t">
                        <button 
                            type="button" 
                            @click="createSubscriptionModalOpen = false" 
                            class="py-2 px-4 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                            انصراف
                        </button>
                        <button 
                            type="submit" 
                            :disabled="isProcessing || !subscriptionForm.plan_id"
                            class="py-2 px-4 text-sm font-semibold bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!isProcessing">ایجاد اشتراک</span>
                            <span x-show="isProcessing">در حال پردازش...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- مودال ویرایش اشتراک -->
    <div x-show="editSubscriptionModalOpen" x-cloak @keydown.escape.window="editSubscriptionModalOpen = false" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="editSubscriptionModalOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div x-show="editSubscriptionModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-lg">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-800">ویرایش اشتراک</h3>
                    <button @click="editSubscriptionModalOpen = false" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                
                <form @submit.prevent="updateSubscription()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            تغییر پلن اشتراک
                        </label>
                        <select 
                            x-model="editForm.plan_id" 
                            @change="updateEditPlanPrice()"
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                            <template x-for="plan in availablePlans" :key="plan.id">
                                <option :value="plan.id">
                                    <span x-text="plan.name"></span> - 
                                    <span x-text="plan.membership"></span> 
                                    (<span x-text="plan.duration_months"></span> ماه)
                                </option>
                            </template>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            مبلغ (تومان)
                        </label>
                        <input 
                            type="text" 
                            x-model="editForm.payment_amount"
                            readonly
                            class="w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-lg text-slate-600 cursor-not-allowed">
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t">
                        <button 
                            type="button"
                            @click="openDeleteSubscriptionModal()"
                            class="py-2 px-4 text-sm font-semibold bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition flex items-center">
                            <i class="fa-solid fa-trash ml-2"></i>
                            حذف اشتراک
                        </button>
                        
                        <div class="flex space-x-2 space-x-reverse">
                            <button 
                                type="button" 
                                @click="editSubscriptionModalOpen = false" 
                                class="py-2 px-4 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                                انصراف
                            </button>
                            <button 
                                type="submit" 
                                :disabled="isProcessing"
                                class="py-2 px-4 text-sm font-semibold bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition disabled:opacity-50">
                                <span x-show="!isProcessing">ذخیره تغییرات</span>
                                <span x-show="isProcessing">در حال پردازش...</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- مودال تمدید اشتراک -->
    <div x-show="extendSubscriptionModalOpen" x-cloak @keydown.escape.window="extendSubscriptionModalOpen = false" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="extendSubscriptionModalOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div x-show="extendSubscriptionModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-800">تمدید اشتراک</h3>
                    <button @click="extendSubscriptionModalOpen = false" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                
                <form @submit.prevent="extendSubscription()" class="space-y-4">
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <p class="text-sm text-slate-600 mb-2">تاریخ انقضای فعلی:</p>
                        <p class="font-semibold text-slate-800" x-text="activeSubscription?.end_date"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            تعداد روز برای تمدید
                            <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="number" 
                            x-model="extendForm.days_to_add"
                            min="1"
                            max="365"
                            required
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                            placeholder="مثلاً: 30">
                        <p class="text-xs text-slate-500 mt-1">
                            تعداد روزی که می‌خواهید به اشتراک فعلی اضافه شود
                        </p>
                    </div>

                    <div class="flex justify-end space-x-2 space-x-reverse pt-4 border-t">
                        <button 
                            type="button" 
                            @click="extendSubscriptionModalOpen = false" 
                            class="py-2 px-4 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                            انصراف
                        </button>
                        <button 
                            type="submit" 
                            :disabled="isProcessing || !extendForm.days_to_add"
                            class="py-2 px-4 text-sm font-semibold bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition disabled:opacity-50">
                            <span x-show="!isProcessing">تمدید اشتراک</span>
                            <span x-show="isProcessing">در حال پردازش...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- مودال حذف اشتراک -->
    <div x-show="deleteSubscriptionModalOpen" x-cloak @keydown.escape.window="deleteSubscriptionModalOpen = false" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="deleteSubscriptionModalOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div x-show="deleteSubscriptionModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-md">
            <div class="p-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-center text-slate-800 mb-2">حذف اشتراک</h3>
                <p class="text-sm text-slate-600 text-center mb-6">
                    آیا مطمئن هستید که می‌خواهید اشتراک این کاربر را حذف کنید؟
                    <br>
                    <span class="text-red-600 font-semibold">این عملیات قابل بازگشت نیست!</span>
                </p>
                
                <div class="flex justify-center space-x-2 space-x-reverse">
                    <button 
                        @click="deleteSubscriptionModalOpen = false" 
                        class="py-2 px-4 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                        انصراف
                    </button>
                    <button 
                        @click="confirmDeleteSubscription()" 
                        :disabled="isProcessing"
                        class="py-2 px-4 text-sm font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 transition disabled:opacity-50">
                        <span x-show="!isProcessing">بله، حذف کن</span>
                        <span x-show="isProcessing">در حال پردازش...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال تایید با کد نظام پزشکی -->
    <div x-show="approveModalOpen" x-cloak @keydown.escape.window="approveModalOpen = false" class="fixed inset-0 z-50 flex items-center justify-center">
        <div @click="approveModalOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div x-show="approveModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-md m-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-800">تایید احراز هویت</h3>
                    <button @click="approveModalOpen = false" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="bg-yellow-50 border-r-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fa-solid fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="mr-3">
                            <p class="text-sm text-yellow-700">
                                برای تایید هویت کاربر، وارد کردن کد نظام پزشکی <strong>الزامی</strong> است.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="medical_code" class="block text-sm font-medium text-slate-700 mb-2">
                        کد نظام پزشکی
                        <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="medical_code" 
                        x-model="medicalCode"
                        required
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                        placeholder="کد نظام پزشکی را وارد کنید"
                        maxlength="50">
                    <p class="text-xs text-slate-500 mt-1">
                        فقط اعداد مجاز است
                    </p>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 rounded-b-xl flex justify-end space-x-2 space-x-reverse">
                <button 
                    type="button" 
                    @click="approveModalOpen = false; medicalCode = ''" 
                    class="py-2 px-4 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">
                    انصراف
                </button>
                <button 
                    type="button" 
                    @click="confirmApprove()" 
                    :disabled="isProcessing || !medicalCode || medicalCode.length < 5" 
                    class="py-2 px-4 text-sm font-semibold bg-green-500 text-white rounded-lg hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!isProcessing">تایید نهایی</span>
                    <span x-show="isProcessing">در حال پردازش...</span>
                </button>
            </div>
        </div>
    </div>


    <!-- مودال رد -->
    <div x-show="rejectModalOpen" x-cloak @keydown.escape.window="rejectModalOpen = false" class="fixed inset-0 z-50 flex items-center justify-center">
        <div @click="rejectModalOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div x-show="rejectModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-md m-4">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="reject">
                <div class="p-6">
                    <h3 class="text-lg font-bold">لطفاً دلیل رد هویت را بنویسید</h3>
                    <p class="text-sm text-slate-500 mt-1">این پیام برای کاربر ارسال خواهد شد.</p>
                    <textarea name="rejection_reason" rows="4" class="w-full mt-4 p-2 border rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="مثال: تصویر کارت ملی ارسالی خوانا نیست..."></textarea>
                </div>
                <div class="px-6 py-4 bg-slate-50 rounded-b-xl flex justify-end space-x-2 space-x-reverse">
                    <button type="button" @click="rejectModalOpen = false" class="py-2 px-4 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">انصراف</button>
                    <button type="submit" class="py-2 px-4 text-sm font-semibold bg-red-500 text-white rounded-lg hover:bg-red-600 transition">ارسال دلیل و رد کردن</button>
                </div>
            </form>
        </div>
    </div>

    <!-- سایر مودال‌ها -->
    <div x-show="imageViewerOpen" x-cloak @keydown.escape.window="imageViewerOpen = false" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="imageViewerOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div class="relative max-w-4xl max-h-full"><img :src="imageUrl" alt="نمایش مدرک" class="rounded-lg shadow-2xl max-w-full max-h-[90vh]"><button @click="imageViewerOpen = false" class="absolute -top-3 -right-3 bg-white rounded-full p-1.5 text-slate-600 hover:text-red-600 transition"><i class="fa-solid fa-times h-6 w-6"></i></button></div>
    </div>
    
    <div x-show="editModalOpen" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div @click.away="editModalOpen = false" class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">ویرایش کاربر</h3>
                <form id="editForm" method="POST" action="{% url 'dashboard:users:admin_user_update' pk=target_user.pk %}">
                    {% csrf_token %}
                    <div id="editFormBody" class="space-y-4">
                        <p class="text-center text-slate-500">در حال بارگذاری اطلاعات...</p>
                    </div>
                    <div class="flex justify-end space-x-2 space-x-reverse mt-6">
                        <button type="button" @click="editModalOpen = false" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">انصراف</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ذخیره تغییرات</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div x-show="deleteModalOpen" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div @click.away="deleteModalOpen = false" class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><i class="fa-solid fa-triangle-exclamation h-6 w-6 text-red-600"></i></div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">حذف کاربر</h3>
                <p class="text-sm text-gray-500 mb-4">آیا مطمئن هستید که می‌خواهید <strong x-text="userName"></strong> را حذف کنید؟</p>
                <div class="flex justify-center space-x-2 space-x-reverse">
                    <button @click="deleteModalOpen = false" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">انصراف</button>
                    <button @click="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">بله، حذف کن</button>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('userDetailComponent', (userId, userName) => ({
        // --- State Variables ---
        rejectModalOpen: false,
        approveModalOpen: false,
        imageViewerOpen: false,
        imageUrl: '',
        editModalOpen: false,
        deleteModalOpen: false,
        userId: userId,
        userName: userName,
        medicalCode: '',
        isProcessing: false,

        // Subscription related states
        createSubscriptionModalOpen: false,
        editSubscriptionModalOpen: false,
        extendSubscriptionModalOpen: false,
        deleteSubscriptionModalOpen: false,
        hasActiveSubscription: false,
        activeSubscription: null,
        allSubscriptions: [],
        availablePlans: [],
        
        subscriptionForm: {
            user_id: userId,
            plan_id: '',
            payment_amount: ''
        },
        
        editForm: {
            subscription_id: '',
            plan_id: '',
            payment_amount: '',
            status: 'active'
        },
        
        extendForm: {
            days_to_add: 30
        },

        selectedPlanInfo: null,

        // --- Init Method ---
        init() {
            this.loadSubscriptionData();
            this.loadAvailablePlans();
        },

        // --- Subscription Functions ---
        async loadSubscriptionData() {
            try {
                const response = await fetch(`/dashboard/admin/subscriptions/user/${this.userId}/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.hasActiveSubscription = data.has_active_subscription;
                    this.activeSubscription = data.active_subscription;
                    this.allSubscriptions = data.subscriptions;
                }
            } catch (error) {
                console.error('Error loading subscription data:', error);
            }
        },

        async loadAvailablePlans() {
            try {
                const response = await fetch('/dashboard/admin/subscriptions/plans/', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.availablePlans = data.plans;
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        },

        openCreateSubscriptionModal() {
            this.subscriptionForm = {
                user_id: this.userId,
                plan_id: '',
                payment_amount: ''
            };
            this.selectedPlanInfo = null;
            this.createSubscriptionModalOpen = true;
        },

        updatePlanPrice() {
            const selectedPlan = this.availablePlans.find(p => p.id == this.subscriptionForm.plan_id);
            if (selectedPlan) {
                this.subscriptionForm.payment_amount = this.formatNumber(selectedPlan.price);
                this.selectedPlanInfo = selectedPlan;
            }
        },

        async createSubscription() {
            this.isProcessing = true;
            
            try {
                const formData = new FormData();
                formData.append('user_id', this.subscriptionForm.user_id);
                formData.append('plan_id', this.subscriptionForm.plan_id);
                formData.append('payment_amount', this.subscriptionForm.payment_amount.replace(/,/g, ''));
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const response = await fetch('/dashboard/admin/subscriptions/create/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showNotification(data.message, 'success');
                    this.createSubscriptionModalOpen = false;
                    await this.loadSubscriptionData();
                } else {
                    this.showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error creating subscription:', error);
                this.showNotification('خطا در ایجاد اشتراک', 'error');
            } finally {
                this.isProcessing = false;
            }
        },

        async openEditSubscriptionModal() {
            if (!this.activeSubscription) return;
            
            try {
                const response = await fetch(`/dashboard/admin/subscriptions/${this.activeSubscription.id}/edit/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.editForm = {
                        subscription_id: data.subscription.id,
                        plan_id: data.subscription.plan_id,
                        payment_amount: this.formatNumber(data.subscription.payment_amount),
                        status: data.subscription.status
                    };
                    this.editSubscriptionModalOpen = true;
                }
            } catch (error) {
                console.error('Error loading subscription:', error);
                this.showNotification('خطا در بارگذاری اطلاعات', 'error');
            }
        },

        updateEditPlanPrice() {
            const selectedPlan = this.availablePlans.find(p => p.id == this.editForm.plan_id);
            if (selectedPlan) {
                this.editForm.payment_amount = this.formatNumber(selectedPlan.price);
            }
        },

        async updateSubscription() {
            this.isProcessing = true;
            
            try {
                const formData = new FormData();
                formData.append('plan_id', this.editForm.plan_id);
                formData.append('payment_amount', this.editForm.payment_amount.replace(/,/g, ''));
                formData.append('status', this.editForm.status);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const response = await fetch(`/dashboard/admin/subscriptions/${this.editForm.subscription_id}/edit/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showNotification(data.message, 'success');
                    this.editSubscriptionModalOpen = false;
                    await this.loadSubscriptionData();
                } else {
                    this.showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error updating subscription:', error);
                this.showNotification('خطا در بروزرسانی اشتراک', 'error');
            } finally {
                this.isProcessing = false;
            }
        },

        openExtendSubscriptionModal() {
            this.extendForm.days_to_add = 30;
            this.extendSubscriptionModalOpen = true;
        },

        async extendSubscription() {
            if (!this.activeSubscription) return;
            
            this.isProcessing = true;
            
            try {
                const formData = new FormData();
                formData.append('days_to_add', this.extendForm.days_to_add);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const response = await fetch(`/dashboard/admin/subscriptions/${this.activeSubscription.id}/extend/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showNotification(data.message, 'success');
                    this.extendSubscriptionModalOpen = false;
                    await this.loadSubscriptionData();
                } else {
                    this.showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error extending subscription:', error);
                this.showNotification('خطا در تمدید اشتراک', 'error');
            } finally {
                this.isProcessing = false;
            }
        },

        openDeleteSubscriptionModal() {
            this.editSubscriptionModalOpen = false;
            this.deleteSubscriptionModalOpen = true;
        },

        async confirmDeleteSubscription() {
            if (!this.activeSubscription) return;
            
            this.isProcessing = true;
            
            try {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const response = await fetch(`/dashboard/admin/subscriptions/${this.activeSubscription.id}/delete/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showNotification(data.message, 'success');
                    this.deleteSubscriptionModalOpen = false;
                    await this.loadSubscriptionData();
                } else {
                    this.showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting subscription:', error);
                this.showNotification('خطا در حذف اشتراک', 'error');
            } finally {
                this.isProcessing = false;
            }
        },

        formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        },

        // --- User Functions ---
        confirmApprove() {
            if (!this.medicalCode || this.medicalCode.trim() === '') {
                this.showNotification('لطفاً کد نظام پزشکی را وارد کنید', 'error');
                return;
            }
            
            if (this.medicalCode.length < 5) {
                this.showNotification('کد نظام پزشکی باید حداقل ۵ رقم باشد', 'error');
                return;
            }
            
            this.isProcessing = true;
            
            const formData = new FormData();
            formData.append('action', 'approve');
            formData.append('medical_code', this.medicalCode);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showNotification(data.message, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    this.showNotification(data.message || 'خطا در پردازش درخواست', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showNotification('خطا در ارتباط با سرور', 'error');
            })
            .finally(() => {
                this.isProcessing = false;
            });
        },

        showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-4 right-4 p-4 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        },

        openEditModal() {
            fetch(`/dashboard/admin/users/${this.userId}/edit/`)
                .then(response => response.json())
                .then(data => {
                    const formBody = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نام</label>
                            <input type="text" name="first_name" value="${data.first_name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نام خانوادگی</label>
                            <input type="text" name="last_name" value="${data.last_name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ایمیل</label>
                            <input type="email" name="email" value="${data.email || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نقش</label>
                            <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="visitor" ${data.role === 'visitor' ? 'selected' : ''}>بازدیدکننده</option>
                                <option value="regular" ${data.role === 'regular' ? 'selected' : ''}>کاربر عادی</option>
                                <option value="premium" ${data.role === 'premium' ? 'selected' : ''}>کاربر ویژه</option>
                                <option value="admin" ${data.role === 'admin' ? 'selected' : ''}>ادمین</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">وضعیت احراز هویت</label>
                            <select name="auth_status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="PENDING" ${data.auth_status === 'PENDING' ? 'selected' : ''}>در انتظار تایید</option>
                                <option value="APPROVED" ${data.auth_status === 'APPROVED' ? 'selected' : ''}>تایید شده</option>
                                <option value="REJECTED" ${data.auth_status === 'REJECTED' ? 'selected' : ''}>رد شده</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" name="is_active" class="w-4 h-4 text-blue-600" ${data.is_active ? 'checked' : ''}>
                                <span class="mr-2 text-sm text-gray-700">کاربر فعال</span>
                            </label>
                        </div>
                    `;
                    document.getElementById('editFormBody').innerHTML = formBody;
                    this.editModalOpen = true;
                })
                .catch(error => console.error('Error fetching user data:', error));
        },

        openDeleteModal() {
            this.deleteModalOpen = true;
        },

        confirmDelete() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(`/dashboard/admin/users/${this.userId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = "{% url 'dashboard:users:admin_users_list' %}";
                } else {
                    alert('خطا در حذف کاربر.');
                }
            })
            .catch(error => console.error('Error deleting user:', error));
        }
    }));
});
</script>
{% endblock %}
