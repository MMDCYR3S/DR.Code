{% extends 'dashboard/base.html' %}
{% load file_filters %}

{% block title %}جزئیات کاربر: {{ target_user.full_name }}{% endblock %}

{% block content %}
<main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-4 sm:p-6" 
      x-data="userDetailComponent({{ target_user.id }}, '{{ target_user.full_name|escapejs }}')">
    <div class="container mx-auto">
        <div class="flex items-center space-x-2 space-x-reverse mb-6">
            <h1 class="text-2xl font-bold text-slate-700">{{ target_user.full_name }}</h1>
            
            {% if profile.auth_status == 'PENDING' %}
                <span class="px-3 py-1 text-xs font-semibold text-orange-800 bg-orange-200 rounded-full">در انتظار تایید</span>
            {% elif profile.auth_status == 'APPROVED' %}
                <span class="px-3 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">تایید شده</span>
            {% elif profile.auth_status == 'REJECTED' %}
                <span class="px-3 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">رد شده</span>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">مدارک ارسالی</h3>
                    <div class="space-y-4">
                        {% if documents %}
                            <div class="grid grid-cols-2 gap-3">
                                {% for doc in documents %}
                                    {% if doc.file.url|file_filter == 'pdf' %}
                                        <a href="{{ doc.file.url }}" target="_blank" download class="col-span-2 flex items-center justify-center text-center p-4 bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold rounded-lg transition-colors border border-blue-200">
                                            <i class="fa-solid fa-file-pdf text-xl ml-3"></i>
                                            <span>دانلود فایل PDF</span>
                                        </a>
                                    {% else %}
                                        <button @click="imageUrl = '{{ doc.file.url }}'; imageViewerOpen = true" class="focus:outline-none">
                                            <img src="{{ doc.file.url }}" alt="مدرک" class="rounded-lg w-full h-auto object-cover border-2 border-slate-200 hover:border-blue-400 transition">
                                        </button>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-sm text-slate-500">هیچ مدرکی بارگذاری نشده است.</p>
                        {% endif %}
                        {% if profile.auth_link %}
                        <div>
                            <a href="{{ profile.auth_link }}" target="_blank" class="inline-flex items-center text-sm text-blue-600 hover:underline">
                                <span>لینک صفحه نظام پزشکی</span>
                                <i class="fa-solid fa-arrow-up-right-from-square mr-1.5 h-4 w-4"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                {% if profile.auth_status == 'PENDING' %}
                <div x-transition class="bg-white p-6 rounded-xl shadow-sm border-2 border-dashed border-orange-300">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">بررسی و تایید هویت کاربر</h3>
                    <form method="POST" class="flex flex-col sm:flex-row gap-4">
                        {% csrf_token %}
                        <button type="submit" name="action" value="approve" class="w-full py-3 px-5 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition">تایید هویت</button>
                        <button type="button" @click="rejectModalOpen = true" class="w-full py-3 px-5 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition">رد هویت</button>
                    </form>
                </div>
                {% endif %}

                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">مشخصات کاربری</h3>
                    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div class="flex flex-col"><dt class="text-slate-500">نام و نام خانوادگی:</dt><dd class="font-medium mt-1">{{ target_user.full_name }}</dd></div>
                        <div class="flex flex-col"><dt class="text-slate-500">شماره تماس:</dt><dd class="font-medium mt-1">{{ target_user.phone_number }}</dd></div>
                        <div class="flex flex-col"><dt class="text-slate-500">ایمیل:</dt><dd class="font-medium mt-1">{{ target_user.email|default:"ثبت نشده" }}</dd></div>
                        <div class="flex flex-col"><dt class="text-slate-500">تاریخ ثبت نام:</dt><dd class="font-medium mt-1">{{ target_user.shamsi_date_joined }}</dd></div>
                        <div class="flex flex-col sm:col-span-2"><dt class="text-slate-500">کد نظام پزشکی / دانشجویی:</dt>
                            <dd class="font-medium mt-1 p-2 bg-slate-50 rounded-md">
                                {% if profile.medical_code %}{{ profile.medical_code }}{% else %}<span class="text-slate-400 italic">وارد نشده</span>{% endif %}
                            </dd>
                        </div>
                    </dl>
                    <div class="border-t mt-6 pt-4 flex flex-wrap gap-3">
                        <button @click="openEditModal()" class="flex-1 min-w-[150px] py-2 px-4 text-sm font-semibold bg-blue-200 text-blue-700 rounded-lg hover:bg-blue-300 transition">ویرایش مشخصات</button>
                        <button @click="openDeleteModal()" class="flex-1 min-w-[150px] py-2 px-4 text-sm font-semibold bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition">حذف کاربر</button>
                        <button onclick="window.location.href='{% url 'dashboard:users:users_list' %}'" class="flex-1 min-w-[150px] py-2 px-4 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">بازگشت</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="rejectModalOpen" x-cloak @keydown.escape.window="rejectModalOpen = false" class="fixed inset-0 z-50 flex items-center justify-center">
        <div @click="rejectModalOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div x-show="rejectModalOpen" x-transition class="relative bg-white rounded-xl shadow-lg w-full max-w-md m-4">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="reject">
                <div class="p-6">
                    <h3 class="text-lg font-bold">لطفاً دلیل رد هویت را بنویسید</h3>
                    <p class="text-sm text-slate-500 mt-1">این پیام برای کاربر ارسال خواهد شد.</p>
                    <textarea name="rejection_reason" rows="4" class="w-full mt-4 p-2 border rounded-lg bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="مثال: تصویر کارت ملی ارسالی خوانا نیست..."></textarea>
                </div>
                <div class="px-6 py-4 bg-slate-50 rounded-b-xl flex justify-end space-x-2 space-x-reverse">
                    <button type="button" @click="rejectModalOpen = false" class="py-2 px-4 text-sm font-semibold bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">انصراف</button>
                    <button type="submit" class="py-2 px-4 text-sm font-semibold bg-red-500 text-white rounded-lg hover:bg-red-600 transition">ارسال دلیل و رد کردن</button>
                </div>
            </form>
        </div>
    </div>
    <div x-show="imageViewerOpen" x-cloak @keydown.escape.window="imageViewerOpen = false" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div @click="imageViewerOpen = false" class="absolute inset-0 bg-gray-600 bg-opacity-50"></div>
        <div class="relative max-w-4xl max-h-full"><img :src="imageUrl" alt="نمایش مدرک" class="rounded-lg shadow-2xl max-w-full max-h-[90vh]"><button @click="imageViewerOpen = false" class="absolute -top-3 -right-3 bg-white rounded-full p-1.5 text-slate-600 hover:text-red-600 transition"><i class="fa-solid fa-times h-6 w-6"></i></button></div>
    </div>
    <div x-show="editModalOpen" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div @click.away="editModalOpen = false" class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">ویرایش کاربر</h3>
                <form id="editForm" method="POST" action="{% url 'dashboard:users:admin_user_update' pk=target_user.pk %}">
                    {% csrf_token %}
                    <div id="editFormBody" class="space-y-4">
                        <p class="text-center text-slate-500">در حال بارگذاری اطلاعات...</p>
                    </div>
                    <div class="flex justify-end space-x-2 space-x-reverse mt-6">
                        <button type="button" @click="editModalOpen = false" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">انصراف</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ذخیره تغییرات</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div x-show="deleteModalOpen" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div @click.away="deleteModalOpen = false" class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><i class="fa-solid fa-triangle-exclamation h-6 w-6 text-red-600"></i></div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">حذف کاربر</h3>
                <p class="text-sm text-gray-500 mb-4">آیا مطمئن هستید که می‌خواهید <strong x-text="userName"></strong> را حذف کنید؟</p>
                <div class="flex justify-center space-x-2 space-x-reverse">
                    <button @click="deleteModalOpen = false" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">انصراف</button>
                    <button @click="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">بله، حذف کن</button>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('userDetailComponent', (userId, userName) => ({
        // ... State Variables ...
        rejectModalOpen: false,
        imageViewerOpen: false,
        imageUrl: '',
        editModalOpen: false,
        deleteModalOpen: false,
        userId: userId,
        userName: userName,

        // --- Functions ---
        openEditModal() {
            fetch(`/dashboard/admin/users/${this.userId}/edit/`)
                .then(response => response.json())
                .then(data => {
                    const formBody = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نام</label>
                            <input type="text" name="first_name" value="${data.first_name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نام خانوادگی</label>
                            <input type="text" name="last_name" value="${data.last_name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ایمیل</label>
                            <input type="email" name="email" value="${data.email || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نقش</label>
                            <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="visitor" ${data.role === 'visitor' ? 'selected' : ''}>بازدیدکننده</option>
                                <option value="regular" ${data.role === 'regular' ? 'selected' : ''}>کاربر عادی</option>
                                <option value="premium" ${data.role === 'premium' ? 'selected' : ''}>کاربر ویژه</option>
                                <option value="admin" ${data.role === 'admin' ? 'selected' : ''}>ادمین</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">وضعیت احراز هویت</label>
                            <select name="auth_status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="PENDING" ${data.auth_status === 'PENDING' ? 'selected' : ''}>در انتظار تایید</option>
                                <option value="APPROVED" ${data.auth_status === 'APPROVED' ? 'selected' : ''}>تایید شده</option>
                                <option value="REJECTED" ${data.auth_status === 'REJECTED' ? 'selected' : ''}>رد شده</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" name="is_active" class="w-4 h-4 text-blue-600" ${data.is_active ? 'checked' : ''}>
                                <span class="mr-2 text-sm text-gray-700">کاربر فعال</span>
                            </label>
                        </div>
                    `;
                    document.getElementById('editFormBody').innerHTML = formBody;
                    this.editModalOpen = true;
                })
                .catch(error => console.error('Error fetching user data:', error));
        },

        openDeleteModal() {
            this.deleteModalOpen = true;
        },

        confirmDelete() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(`/dashboard/admin/users/${this.userId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = "{% url 'dashboard:users:users_list' %}";
                } else {
                    alert('خطا در حذف کاربر.');
                }
            })
            .catch(error => console.error('Error deleting user:', error));
        }
    }));
});
</script>
{% endblock %}