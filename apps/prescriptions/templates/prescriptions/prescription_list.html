<!-- templates/prescriptions/prescription_list.html -->

{% extends "base.html" %}

{% block title %}لیست نسخه‌ها{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>لیست تمام نسخه‌ها</h1>
    <hr>
    
    <!-- محلی برای نمایش لیست نسخه‌ها -->
    <div id="prescription-list-container" class="row">
        <!-- پیام اولیه برای کاربر -->
        <p>در حال بارگذاری نسخه‌ها، لطفاً شکیبا باشید...</p>
    </div>

    <!-- اینجا می‌توانیم دکمه‌های صفحه‌بندی را اضافه کنیم -->
    <nav id="pagination-container" aria-label="Page navigation"></nav>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const listContainer = document.getElementById('prescription-list-container');
    const paginationContainer = document.getElementById('pagination-container');

    // آدرس API لیست نسخه‌ها (مطمئن شوید این آدرس با ساختار API شما مطابقت دارد)
    const apiListUrl = '/api/v1/prescriptions/';

    // تابعی برای واکشی و نمایش داده‌ها
    function fetchAndRenderPrescriptions(url) {
        // نمایش حالت لودینگ
        listContainer.innerHTML = '<p>در حال بارگذاری نسخه‌ها...</p>';

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`خطای شبکه: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // پاک کردن محتوای قبلی
                listContainer.innerHTML = '';
                
                const prescriptions = data.results; // در DRF لیست اصلی در 'results' است

                if (prescriptions && prescriptions.length > 0) {
                    prescriptions.forEach(prescription => {
                        // ساخت URL فرانت‌اند برای جزئیات هر نسخه
                        const detailPageUrl = `/prescriptions/${prescription.slug}/`;

                        // ساختن کارت برای هر نسخه
                        const cardHtml = `
                            <div class="col-md-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">${prescription.primary_name}</h5>
                                        <p class="card-text text-muted small">${prescription.all_names.join(', ')}</p>
                                        
                                        <div class="mt-auto">
                                            <span class="badge" style="background-color: ${prescription.category.color_code || '#6c757d'}; color: white;">
                                                ${prescription.category.title}
                                            </span>
                                            <span class="badge bg-${prescription.access_level === 'PREMIUM' ? 'warning' : 'success'}">
                                                ${prescription.access_level === 'PREMIUM' ? 'ویژه' : 'رایگان'}
                                            </span>
                                            <br>
                                            <!-- لینک به صفحه جزئیات -->
                                            <a href="${detailPageUrl}" class="btn btn-primary btn-sm mt-3">مشاهده جزئیات</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        listContainer.insertAdjacentHTML('beforeend', cardHtml);
                    });
                    
                    // رندر کردن دکمه‌های صفحه‌بندی
                    renderPagination(data.count, data.next, data.previous);

                } else {
                    listContainer.innerHTML = '<p>هیچ نسخه‌ای یافت نشد.</p>';
                }
            })
            .catch(error => {
                console.error('خطا در دریافت لیست نسخه‌ها:', error);
                listContainer.innerHTML = '<p class="alert alert-danger">خطایی در بارگذاری اطلاعات رخ داد. لطفاً دوباره تلاش کنید.</p>';
            });
    }

    // تابعی برای ساخت دکمه‌های صفحه‌بندی
    function renderPagination(count, next, previous) {
        paginationContainer.innerHTML = ''; // پاک کردن دکمه‌های قبلی
        let paginationHtml = '<ul class="pagination">';

        if (previous) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-url="${previous}">قبلی</a></li>`;
        } else {
            paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#">قبلی</a></li>`;
        }

        if (next) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-url="${next}">بعدی</a></li>`;
        } else {
            paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#">بعدی</a></li>`;
        }

        paginationHtml += '</ul>';
        paginationContainer.innerHTML = paginationHtml;
    }

    // اضافه کردن Event Listener برای دکمه‌های صفحه‌بندی
    paginationContainer.addEventListener('click', function(e) {
        e.preventDefault();
        const target = e.target;
        if (target.tagName === 'A' && target.dataset.url) {
            fetchAndRenderPrescriptions(target.dataset.url);
        }
    });

    // فراخوانی اولیه برای بارگذاری صفحه اول
    fetchAndRenderPrescriptions(apiListUrl);
});
</script>
{% endblock %}
