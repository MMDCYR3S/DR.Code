{% extends 'base.html' %}
{% load static %}

{% block title %}پروفایل{% endblock title %}

{% block extra_css %}
<style>
    /* Gradient backgrounds */
    .gradient-primary {
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
        }
        
        .gradient-secondary {
            background: linear-gradient(135deg, #00b4d8 0%, #00a896 100%);
        }
        
        /* Glass effect */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 119, 182, 0.2);
        }
        
        /* Loading skeleton */
        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }
        
        .skeleton {
            background: linear-gradient(to right, #f0f0f0 8%, #f8f8f8 18%, #f0f0f0 33%);
            background-size: 936px 104px;
            animation: shimmer 1.5s infinite linear;
        }
        
        /* Status badges */
        .badge-verified {
            background: linear-gradient(135deg, #00a896 0%, #00b4d8 100%);
        }
        
        .badge-pending {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        
        .badge-premium {
            background: linear-gradient(135deg, #f59e0b 0%, #dc2626 100%);
        }
        
        /* Responsive grid */
        .dashboard-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
</style>
{% endblock extra_css %}

{% block content %}
<div class="BASE__DIV" x-data="profileApp()">
<!-- Main Container -->
<div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
    <!-- Profile Header -->
    <div class="max-w-7xl mx-auto" data-aos="fade-down">
        <div class="glass rounded-2xl shadow-lg p-6 sm:p-8 mb-8">
            <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                <!-- Avatar -->
                <div class="relative">
                    <div class="w-32 h-32 rounded-full gradient-primary p-1">
                        <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
                            <i class="fas fa-user-md text-5xl text-c1"></i>
                        </div>
                    </div>
                    <!-- Status Badge -->
                    <div x-show="profileData.role === 'premium'" 
                         class="absolute -top-2 -right-2 badge-premium text-white px-3 py-1 rounded-full text-xs font-medium shadow-lg">
                        <i class="fas fa-crown ml-1"></i>
                        ویژه
                    </div>
                </div>
                
                <!-- User Info -->
                <div class="flex-1 text-center md:text-right">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2" x-text="profileData.user_full_name || 'در حال بارگذاری...'"></h1>
                    <p class="text-gray-600 mb-4" x-text="profileData.user_phone || ''"></p>
                    
                    <!-- Status Badges -->
                    <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                        <!-- Account Type -->
                        <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium"
                             :class="profileData.role === 'premium' ? 'badge-premium text-white' : 'bg-gray-200 text-gray-700'">
                            <i class="fas ml-2" :class="profileData.role === 'premium' ? 'fa-crown' : 'fa-user'"></i>
                            <span x-text="profileData.role === 'premium' ? 'کاربر ویژه' : 'کاربر رایگان'"></span>
                        </div>
                        
                        <!-- Auth Status -->
                        <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium"
                             :class="{
                                 'badge-verified text-white': profileData.auth_status === 'VERIFIED',
                                 'badge-pending text-white': profileData.auth_status === 'PENDING',
                                 'bg-red-500 text-white': profileData.auth_status === 'REJECTED'
                             }">
                            <i class="fas ml-2" :class="{
                                'fa-check-circle': profileData.auth_status === 'VERIFIED',
                                'fa-clock': profileData.auth_status === 'PENDING',
                                'fa-times-circle': profileData.auth_status === 'REJECTED'
                            }"></i>
                            <span x-text="profileData.auth_status_display || 'در انتظار'"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Medical Code -->
                <div x-show="profileData.medical_code" 
                     class="bg-c5 rounded-xl p-4 text-center"
                     data-aos="fade-left">
                    <p class="text-sm text-gray-600 mb-1">کد نظام پزشکی</p>
                    <p class="text-xl font-bold text-c1" x-text="profileData.medical_code"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="max-w-7xl mx-auto mb-8">
        <div class="dashboard-grid">
            <!-- Subscription Status -->
            <div x-show="profileData.role === 'premium'" 
                 class="glass rounded-xl p-6 card-hover"
                 data-aos="fade-up"
                 data-aos-delay="100">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-amber-100 rounded-lg">
                        <i class="fas fa-calendar-alt text-2xl text-amber-600"></i>
                    </div>
                    <span class="text-sm font-medium text-amber-600">اشتراک ویژه</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">زمان باقیمانده</h3>
                <p class="text-2xl font-bold text-c1" x-text="getRemainingDays() + ' روز'"></p>
                <p class="text-sm text-gray-500 mt-2">
                    انقضا: <span x-text="formatDate(profileData.subscription_end_date)"></span>
                </p>
            </div>
            
            <!-- Member Since -->
            <div class="glass rounded-xl p-6 card-hover"
                 data-aos="fade-up"
                 data-aos-delay="200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-c5 rounded-lg">
                        <i class="fas fa-user-clock text-2xl text-c1"></i>
                    </div>
                    <span class="text-sm font-medium text-c1">عضویت</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">مدت عضویت</h3>
                <p class="text-2xl font-bold text-gray-700" x-text="getMembershipDuration()"></p>
                <p class="text-sm text-gray-500 mt-2">
                    از تاریخ: <span x-text="formatDate(profileData.created_at)"></span>
                </p>
            </div>
            
            <!-- Quick Stats -->
            <div class="glass rounded-xl p-6 card-hover"
                 data-aos="fade-up"
                 data-aos-delay="300">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-chart-line text-2xl text-green-600"></i>
                    </div>
                    <span class="text-sm font-medium text-green-600">فعالیت</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">وضعیت حساب</h3>
                <p class="text-2xl font-bold text-green-600">فعال</p>
                <p class="text-sm text-gray-500 mt-2">
                    آخرین بروزرسانی: <span x-text="formatDate(profileData.updated_at)"></span>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Action Cards -->
    <div class="max-w-7xl mx-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-6" data-aos="fade-right">دسترسی سریع</h2>
        
        <div class="dashboard-grid">
            <!-- Saved Prescriptions -->
            <a href="/profile/saved-prescriptions" 
               class="glass rounded-xl p-6 card-hover group cursor-pointer"
               data-aos="fade-up"
               data-aos-delay="100">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-4 bg-c5 rounded-xl group-hover:bg-c4 transition-colors">
                        <i class="fas fa-bookmark text-3xl text-c1"></i>
                    </div>
                    <i class="fas fa-chevron-left text-gray-400 group-hover:text-c1 transition-colors"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">نسخه‌های ذخیره شده</h3>
                <p class="text-gray-600">مشاهده و مدیریت نسخه‌های ذخیره شده</p>
            </a>
            
            <!-- Q&A -->
            <a href="/profile/questions" 
               class="glass rounded-xl p-6 card-hover group cursor-pointer"
               data-aos="fade-up"
               data-aos-delay="200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-4 bg-amber-50 rounded-xl group-hover:bg-amber-100 transition-colors">
                        <i class="fas fa-comments text-3xl text-amber-600"></i>
                    </div>
                    <i class="fas fa-chevron-left text-gray-400 group-hover:text-amber-600 transition-colors"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">پاسخ‌ها و سوالات</h3>
                <p class="text-gray-600">مشاهده سوالات و پاسخ‌های دریافتی</p>
            </a>
            
            <!-- User Info -->
            <a href="/profile/info" 
               class="glass rounded-xl p-6 card-hover group cursor-pointer"
               data-aos="fade-up"
               data-aos-delay="300">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-4 bg-purple-50 rounded-xl group-hover:bg-purple-100 transition-colors">
                        <i class="fas fa-user-edit text-3xl text-purple-600"></i>
                    </div>
                    <i class="fas fa-chevron-left text-gray-400 group-hover:text-purple-600 transition-colors"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">اطلاعات کاربری</h3>
                <p class="text-gray-600">مشاهده و ویرایش اطلاعات شخصی</p>
            </a>
            
            <!-- Notifications -->
            <a href="/profile/notifications" 
               class="glass rounded-xl p-6 card-hover group cursor-pointer relative"
               data-aos="fade-up"
               data-aos-delay="400">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-4 bg-red-50 rounded-xl group-hover:bg-red-100 transition-colors relative">
                        <i class="fas fa-bell text-3xl text-red-600"></i>
                        <!-- Notification badge -->
                        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center">
                            3
                        </span>
                    </div>
                    <i class="fas fa-chevron-left text-gray-400 group-hover:text-red-600 transition-colors"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">اعلان‌ها</h3>
                <p class="text-gray-600">مشاهده آخرین اعلان‌ها و پیام‌ها</p>
            </a>
        </div>
    </div>
    
    <!-- Loading State -->
    <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 shadow-2xl">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-c1 mx-auto"></div>
            <p class="mt-4 text-gray-600">در حال بارگذاری...</p>
        </div>
    </div>
</div>
</div>


{% endblock content %}

{% block extra_js %}
<script>
     // profile__API Configuration
     const profile__API = {
            BASE_URL: window.location.origin + '/',
            ENDPOINTS: {
                PROFILE: 'api/v1/accounts/profile/'
            }
        };
        
        // Initialize AOS
        AOS.init({
            duration: 800,
            easing: 'ease-out',
            once: true,
            offset: 50
        });
        
        // Alpine.js Profile Component
        function profileApp() {
            return {
                profileData: {},
                loading: true,
                
                async init() {
                    await this.loadProfile();
                },
                
                async loadProfile() {
                    try {
                        this.loading = true;
                        
                        const response = await axios.get(`${profile__API.BASE_URL}${profile__API.ENDPOINTS.PROFILE}`, {
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`
                            }
                        });
                        
                        this.profileData = response.data;
                        
                    } catch (error) {
                        console.error('Error loading profile:', error);
                        
                        if (error.response && error.response.status === 401) {
                            // Redirect to login
                            window.location.href = '/login';
                            return;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'خطا',
                            text: 'خطا در بارگذاری اطلاعات پروفایل',
                            confirmButtonText: 'باشه',
                            confirmButtonColor: '#0077b6'
                        });
                    } finally {
                        this.loading = false;
                    }
                },
                
                getAuthToken() {
                    // Get token from localStorage or cookie
                    return localStorage.getItem('authToken') || '';
                },
                
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return new Intl.DateTimeFormat('fa-IR').format(date);
                },
                
                getRemainingDays() {
                    if (!this.profileData.subscription_end_date) return 0;
                    const endDate = new Date(this.profileData.subscription_end_date);
                    const today = new Date();
                    const diffTime = endDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays > 0 ? diffDays : 0;
                },
                
                getMembershipDuration() {
                    if (!this.profileData.created_at) return '';
                    const created = new Date(this.profileData.created_at);
                    const now = new Date();
                    const months = Math.floor((now - created) / (1000 * 60 * 60 * 24 * 30));
                    
                    if (months < 1) return 'کمتر از یک ماه';
                    if (months === 1) return 'یک ماه';
                    if (months < 12) return `${months} ماه`;
                    
                    const years = Math.floor(months / 12);
                    const remainingMonths = months % 12;
                    
                    if (remainingMonths === 0) {
                        return years === 1 ? 'یک سال' : `${years} سال`;
                    }
                    
                    return `${years} سال و ${remainingMonths} ماه`;
                }
            };
        }
</script>
{% endblock extra_js %}
    